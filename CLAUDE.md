# CDC 프로젝트 컨텍스트

## 프로젝트 정보

- **프로젝트명**: 법원도서관 미래통합관리시스템 구축 및 데이터 연계 활용성 강화
- **현재 단계**: 분석/설계
- **담당 영역**: CDC 동기화, API 연동

## 핵심 배경

- 기존 CLIMS(법원도서관 통합관리시스템)에서 미래통합관리시스템으로 전환
- **TOBE는 ASIS를 표준화하여 스키마가 다름** (컬럼명, 타입, 코드값 등 변환 필요)
- 1차에서 일부 시스템만 시범 적용 → ASIS/TOBE 공존
- CDC를 통한 양방향 데이터 동기화 필요

## 제약조건

- 기존 CLIMS 테이블 컬럼 추가 불가
- 기존 소스 수정 불가
- 동기화용 테이블 생성 가능
- CDC 솔루션 미정 (PoC에서는 Debezium 사용)

## 아키텍처 요약

```
ASIS CDC Agent → CDC_TOBE_TABLES(TOBE DB) → [스키마변환] → STAGING_TOBES → WORKER → TOBE 원본
TOBE CDC Agent → CDC_ASIS_TABLES(ASIS DB) → [역변환] → STAGING_ASIS → WORKER → ASIS 원본
```

- WORKER는 DB 프로시저로 구현
- **스키마 변환이 핵심** (테이블/컬럼/타입/코드값 매핑)
- 네트워크 통신으로 상대 DB에 전송

## 테이블 분류

| 동기화 방향 | 테이블 수 | 설명 |
|------------|----------|------|
| ASIS → TOBE (단방향) | 47개 | ASIS에서만 관리, TOBE는 읽기만 |
| TOBE → ASIS (단방향) | 55개 | TOBE에서만 관리, ASIS는 읽기만 |
| 양방향 | 69개 | 양쪽 모두 수정 가능, 충돌 위험 |

**총 171개 테이블**

## PoC 환경 (시뮬레이션)

| 구성요소 | 기술 스택 |
|---------|----------|
| DBMS | Oracle XE 21c x 2 (Docker) |
| CDC | Debezium 2.x |
| 메시지 브로커 | Apache Kafka |
| 컨테이너 | Docker Compose |

```
ASIS-Oracle (1521) ←→ Kafka + Debezium ←→ TOBE-Oracle (1522)
```

## 문서 구조

```
docs/
├── 01-설계/     # 설계 문서 (아키텍처, 정책, 케이스 분류)
├── 02-구현/     # 구현 가이드 (소스 설명, 구현 방법)
├── 03-운영/     # 운영 가이드 (환경 구성, 테스트, 트러블슈팅)
├── 04-가이드/   # 사용자 가이드 (입문, 아키텍처 개요)
├── 원본자료/    # 원본 파일 (엑셀, hwp)
└── README.md    # 문서 가이드
```

## 주요 문서 (읽는 순서)

| 목적 | 문서 | 내용 |
|------|------|------|
| **처음 시작** | `docs/04-가이드/12_실전_사용_가이드_초보자용.md` | 환경 시작부터 테스트까지 |
| **전체 구현** | `docs/02-구현/CDC_PoC_완벽_구현_가이드.md` | **통합 구현 가이드 (개념+이유+코드)** |
| **아키텍처** | `docs/04-가이드/15_CDC_PoC_아키텍처_전체_설명.md` | 전체 아키텍처 도식 |
| **설계 상세** | `docs/01-설계/01_CDC_동기화_설계_정리.md` | 전체 설계, 스키마 매핑 정의 |
| **문제 해결** | `docs/03-운영/08_트러블슈팅.md` | 자주 발생하는 문제 해결 |

## 미정 사항

- CDC 솔루션 선정 (프로덕션용)
- 테이블별 상세 매핑 정의
- 동기화 지연 허용 범위
- 충돌 해결 정책 확정

## 작업 규칙

- **Git 커밋 시 "Co-Authored-By: Claude" 메시지 포함하지 않음**

## 문서화 원칙 (필독)

> **중요**: 이 원칙은 **모든 세션에서 동일하게 적용**됩니다.
> auto-compact 발생 후에도 이 파일(CLAUDE.md)을 참조하여 동일한 방식으로 기록하세요.

> **핵심**: 처음 접하는 사람도 읽고 이해하고 따라할 수 있게 작성

### 필수 포함 항목

1. **발생 시점**: 날짜 + 어느 작업 중 발생했는지 (블로그 시간순 정리용)
2. **배경/목적**: 왜 이 작업이 필요한지
3. **문제 현상**: 실제 에러 메시지, 증상
4. **원인 분석**: 왜 이 문제가 발생했는지
5. **해결 방법**: 구체적인 코드/명령어
6. **핵심 포인트**: "기억하세요" 형태로 요약

### 작성 예시

```markdown
### 문제: SQLERRM 오류

> **발생 시점**: 2026-01-13 / Oracle Scheduler Job 추가 후 프로시저 컴파일 시

#### 문제 현상
프로시저 컴파일 시 오류:
\`\`\`
PL/SQL: ORA-00904: "SQLERRM": invalid identifier
\`\`\`

#### 원인 분석
SQLERRM은 PL/SQL 컨텍스트에서만 사용 가능하고,
SQL 문 내부에서는 직접 사용할 수 없습니다.

#### 해결 방법
\`\`\`sql
-- ❌ 잘못된 코드
UPDATE 테이블 SET ERROR_MSG = SUBSTR(SQLERRM, 1, 500);

-- ✅ 올바른 코드
v_err_msg := SUBSTR(SQLERRM, 1, 500);
UPDATE 테이블 SET ERROR_MSG = v_err_msg;
\`\`\`

#### 핵심 포인트
> **기억하세요**: PL/SQL 내장 함수는 SQL 문 내부에서 직접 사용할 수 없습니다.
```

### 시점 기록 형식

트러블슈팅 문서에는 반드시 **발생 시점**을 기록합니다:

```markdown
> **발생 시점**: YYYY-MM-DD / 어느 작업 중 발생했는지
> **상황**: 구체적인 상황 설명 (선택)
```

**예시:**
- `> **발생 시점**: 2026-01-13 / Debezium 커넥터 등록 후 FAILED 상태 확인 시`
- `> **발생 시점**: 2026-01-14 / Docker 재시작 후 테이블 확인 시`

**목적:**
- 블로그 글 작성 시 시간순 정리 가능
- 문제 간의 인과관계 파악 용이
- 동일 문제 재발 시 빠른 참조

### 새 문제 발생 시 기록 절차

**새로운 트러블슈팅 발생 시 반드시 아래 순서로 기록:**

1. **타임라인 표 업데이트** (`docs/03-운영/08_트러블슈팅.md` 상단)
   ```markdown
   | 2026-01-XX | 작업 시점 | 문제 요약 | 섹션번호 |
   ```

2. **해당 섹션에 상세 내용 추가**
   - 발생 시점 (필수)
   - 문제 현상 (에러 메시지)
   - 원인 분석
   - 해결 방법 (코드/명령어)

3. **자주 발생하는 문제 표 업데이트** (CLAUDE.md 하단, 필요시)

### 문서 위치 규칙

| 유형 | 위치 | 파일명 패턴 |
|------|------|-------------|
| 트러블슈팅 | `docs/02-구현/` 또는 `docs/03-운영/` | `*_트러블슈팅_*.md` |
| 개발 기록 | `docs/02-구현/14_개발_진행_기록.md` | 기존 파일에 추가 |
| 설계 변경 | `docs/01-설계/` | 해당 설계 문서에 추가 |

### 트러블슈팅 문서

- **통합 가이드**: `docs/03-운영/08_트러블슈팅.md` (인프라+코드+스키마 문제 모두 포함)

## Docker 환경 시작 절차

```bash
# 1. 환경 시작
cd poc && docker-compose up -d

# 2. Oracle healthy 대기 (1-2분)
docker-compose ps

# 3. Debezium 설정 (ARCHIVELOG, c##dbzuser)
./scripts/setup-debezium-oracle.sh

# 4. 커넥터 등록
./scripts/register-connectors.sh
```

## 자주 발생하는 문제

| 문제 | 원인 | 해결 |
|------|------|------|
| SQLERRM invalid identifier | SQL문 내부에서 직접 사용 | 변수에 먼저 저장 후 사용 |
| 컬럼 not declared | CDC 테이블에 상대방 컬럼 누락 | ALTER TABLE로 컬럼 추가 |
| 프로시저 INVALID | init 스크립트 버그 | 수동 재생성 필요 |
| Debezium 커넥터 FAILED | ARCHIVELOG/c##dbzuser 미설정 | setup-debezium-oracle.sh 실행 |
