# 구축 로그

> **목적**: PoC 환경 구축 과정을 단계별로 기록한 체크리스트입니다.

---

## 진행 상황

| 단계 | 작업 | 상태 | 비고 |
|:----:|------|:----:|------|
| 1 | poc/ 디렉토리 구조 생성 | ✅ 완료 | |
| 2 | docker-compose.yml 작성 | ✅ 완료 | 7개 서비스 정의 |
| 3 | ASIS Oracle 초기화 SQL | ✅ 완료 | 5개 SQL 파일 |
| 4 | TOBE Oracle 초기화 SQL | ✅ 완료 | 5개 SQL 파일 |
| 5 | Sync Service 구현 | ✅ 완료 | Python + Kafka Consumer |
| 6 | 테스트 스크립트 작성 | ✅ 완료 | .bat/.sh 스크립트 |
| 7 | 환경 실행 및 검증 | ✅ 완료 | CDC 동작 확인 |

---

## 상세 로그

### [2025-01-13] 단계 1: 디렉토리 구조 생성

**작업 내용:**
- poc/ 루트 디렉토리 생성
- 하위 디렉토리 구조 생성

**생성할 구조:**
```
poc/
├── docker-compose.yml
├── .env
├── asis-oracle/
│   └── init/
├── tobe-oracle/
│   └── init/
├── sync-service/
│   └── src/
├── kafka/
│   └── connect/
└── scripts/
```

**진행 상태:** ✅ 완료

**결과:**
```
poc/
├── asis-oracle/init/
├── tobe-oracle/init/
├── sync-service/src/
├── kafka/connect/
└── scripts/
```

---

### [2025-01-13] 단계 2: docker-compose.yml 작성

**작업 내용:**
- 6개 서비스 정의 (Oracle 2개 + Kafka 생태계 4개)
- Sync Service는 별도 구현 예정

**정의된 서비스:**

| 서비스 | 이미지 | 포트 | 역할 |
|--------|--------|:----:|------|
| asis-oracle | gvenzl/oracle-xe:21-slim | 1521 | ASIS DB |
| tobe-oracle | gvenzl/oracle-xe:21-slim | 1522 | TOBE DB |
| zookeeper | confluentinc/cp-zookeeper:7.5.0 | 2181 | Kafka 의존성 |
| kafka | confluentinc/cp-kafka:7.5.0 | 9092 | 메시지 브로커 |
| kafka-connect | debezium/connect:2.4 | 8083 | Debezium 호스트 |
| kafka-ui | provectuslabs/kafka-ui | 8081 | 모니터링 UI |

**진행 상태:** ✅ 완료

**참고:**
- Sync Service는 별도 컨테이너 또는 로컬 실행으로 구현 예정
- Oracle XE 이미지는 gvenzl/oracle-xe 사용 (공식 이미지보다 가벼움)

---

### [2025-01-13] 단계 3: ASIS Oracle 초기화 SQL

**작업 내용:**
- 원본 테이블 4개 생성
- CDC 테이블 생성 (CDC_ASIS_*, STAGING_ASIS_*)
- 코드 매핑 테이블 및 데이터
- WORKER 프로시저 생성

**생성된 파일:**

| 파일 | 내용 |
|------|------|
| 01_create_tables.sql | 원본 테이블 (LEGACY_CODE, BOOK_INFO, MEMBER_INFO, NEW_SERVICE_RECV) |
| 02_create_cdc_tables.sql | CDC 테이블, STAGING 테이블, 로그 테이블 |
| 03_create_mapping_tables.sql | 코드 매핑 테이블 및 TOBE→ASIS 매핑 데이터 |
| 04_create_procedures.sql | WORKER 프로시저 (SP_WORKER_BOOK, SP_WORKER_MEMBER 등) |
| 05_insert_sample_data.sql | 샘플 데이터 |

**진행 상태:** ✅ 완료

---

### [2025-01-13] 단계 4: TOBE Oracle 초기화 SQL

**작업 내용:**
- 원본 테이블 4개 생성 (신 스키마 - 표준화)
- CDC 테이블 생성 (CDC_TOBE_*, STAGING_TOBE_*)
- 코드 매핑 테이블 및 데이터 (ASIS→TOBE 방향)
- WORKER 프로시저 생성

**스키마 차이 예시:**

| ASIS (구) | TOBE (신) | 변환 |
|-----------|-----------|------|
| BOOK_INFO.BOOK_TITLE | TB_BOOK.TITLE | 컬럼명 변경 |
| STATUS='Y'/'N' | IS_ACTIVE=1/0 | 코드값 변환 |
| CATEGORY='01' | CATEGORY_CD='LIT' | 코드값 변환 |
| REG_DATE (DATE) | CREATED_AT (TIMESTAMP) | 타입 변환 |

**진행 상태:** ✅ 완료

---

### [2025-01-13] 단계 5: Sync Service 구현

**작업 내용:**
- Python 기반 Kafka Consumer 서비스 구현
- Debezium 이벤트 수신 → 상대 DB CDC 테이블에 INSERT

**구성:**

| 파일 | 역할 |
|------|------|
| sync_service.py | 메인 서비스 코드 |
| requirements.txt | 의존성 (kafka-python, oracledb) |
| Dockerfile | 컨테이너 빌드 |

**동작 흐름:**
```
Debezium → Kafka Topic → Sync Service → 상대 DB CDC_TABLES
```

**진행 상태:** ✅ 완료

---

### [2025-01-13] 단계 6: 테스트 스크립트 작성

**작업 내용:**
- 환경 시작/중지 스크립트
- README.md 작성

**생성된 파일:**

| 파일 | 용도 |
|------|------|
| scripts/01_start_env.bat | 환경 시작 (Windows) |
| scripts/01_start_env.sh | 환경 시작 (Linux/Mac) |
| scripts/02_stop_env.bat | 환경 중지 (Windows) |
| README.md | 사용 가이드 |

**진행 상태:** ✅ 완료

---

### [2025-01-13] 단계 7: 환경 실행 및 검증

**작업 내용:**
- Docker Compose 환경 실행
- Oracle LogMiner 설정
- Oracle JDBC 드라이버 추가
- Debezium 커넥터 등록
- CDC 동작 테스트

---

#### 7-1. Docker Compose 실행

```bash
cd poc
docker compose up -d
```

**결과:** 7개 컨테이너 정상 실행

| 컨테이너 | 상태 | 포트 |
|----------|:----:|:----:|
| asis-oracle | Running (healthy) | 1521 |
| tobe-oracle | Running (healthy) | 1522 |
| zookeeper | Running | 2181 |
| kafka | Running | 9092 |
| kafka-connect | Running | 8083 |
| sync-service | Running | - |
| kafka-ui | Running | 8081 |

---

#### 7-2. Oracle LogMiner 설정

**문제:** Debezium Oracle 커넥터는 LogMiner 설정 필요

**해결:** 양쪽 Oracle에서 실행 (sysdba)
```sql
-- Supplemental Logging 활성화
ALTER DATABASE ADD SUPPLEMENTAL LOG DATA;
ALTER DATABASE ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;

-- Archive Log 모드 전환
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
ALTER DATABASE ARCHIVELOG;
ALTER DATABASE OPEN;
ALTER PLUGGABLE DATABASE ALL OPEN;

-- Debezium 전용 사용자 생성 및 권한 부여
CREATE USER c##dbzuser IDENTIFIED BY dbz
    DEFAULT TABLESPACE USERS QUOTA UNLIMITED ON USERS CONTAINER=ALL;
GRANT CREATE SESSION, SELECT ANY TABLE, FLASHBACK ANY TABLE,
      SELECT_CATALOG_ROLE, EXECUTE_CATALOG_ROLE, LOGMINING TO c##dbzuser CONTAINER=ALL;
-- (이하 LogMiner 관련 권한 추가)
```

---

#### 7-3. Oracle JDBC 드라이버 추가

**문제:** Debezium 이미지에 Oracle JDBC 드라이버 미포함 (라이선스 이유)

**해결:**
```bash
# Maven Central에서 다운로드
curl -L -o kafka-connect/libs/ojdbc11.jar \
    "https://repo1.maven.org/maven2/com/oracle/database/jdbc/ojdbc11/23.3.0.23.09/ojdbc11-23.3.0.23.09.jar"
```

**docker-compose.yml 수정:**
```yaml
kafka-connect:
  volumes:
    - ./kafka-connect/libs/ojdbc11.jar:/kafka/libs/ojdbc11.jar
```

---

#### 7-4. Debezium 커넥터 등록

**문제:** Oracle 21c에서 `CONTINUOUS_MINE` 옵션 제거됨 (ORA-44609)

**해결:** `log.mining.continuous.mine` 옵션 제거

**ASIS/TOBE 커넥터 등록:**
```bash
curl -X POST http://localhost:8083/connectors \
  -H "Content-Type: application/json" \
  -d '{
    "name": "asis-oracle-connector",
    "config": {
      "connector.class": "io.debezium.connector.oracle.OracleConnector",
      "database.hostname": "asis-oracle",
      "database.port": "1521",
      "database.user": "c##dbzuser",
      "database.password": "dbz",
      "database.dbname": "XE",
      "database.pdb.name": "XEPDB1",
      "topic.prefix": "asis",
      "schema.include.list": "ASIS_USER",
      "table.include.list": "ASIS_USER.BOOK_INFO,ASIS_USER.MEMBER_INFO,ASIS_USER.LEGACY_CODE",
      "schema.history.internal.kafka.bootstrap.servers": "kafka:29092",
      "schema.history.internal.kafka.topic": "schema-changes.asis",
      "log.mining.strategy": "online_catalog"
    }
  }'
```

**결과:** 양쪽 커넥터 RUNNING 상태 ✅

---

#### 7-5. CDC 동작 테스트

**테스트:** ASIS DB에서 UPDATE 실행
```sql
UPDATE BOOK_INFO SET BOOK_TITLE = 'CDC테스트-변경된제목' WHERE BOOK_ID = 1;
COMMIT;
```

**Kafka 토픽 확인:**
```bash
docker exec kafka kafka-console-consumer \
    --bootstrap-server localhost:9092 \
    --topic asis.ASIS_USER.BOOK_INFO --from-beginning
```

**결과:** UPDATE 이벤트 캡처 성공! ✅
```json
{
  "op": "u",
  "before": { "BOOK_TITLE": "홍길동전" },
  "after": { "BOOK_TITLE": "CDC테스트-변경된제목" },
  "source": { "table": "BOOK_INFO", "user_name": "ASIS_USER" }
}
```

---

#### 생성된 Kafka 토픽

| 토픽 | 설명 |
|------|------|
| asis.ASIS_USER.BOOK_INFO | ASIS 도서 CDC |
| asis.ASIS_USER.MEMBER_INFO | ASIS 회원 CDC |
| asis.ASIS_USER.LEGACY_CODE | ASIS 레거시코드 CDC |
| tobe.TOBE_USER.TB_BOOK | TOBE 도서 CDC |
| tobe.TOBE_USER.TB_MEMBER | TOBE 회원 CDC |
| tobe.TOBE_USER.TB_NEW_SERVICE | TOBE 신규서비스 CDC |

**진행 상태:** ✅ 완료

---

## 요약

### 완료된 작업

1. **인프라 구성**
   - Docker 기반 PoC 환경 구축 (7개 컨테이너)
   - Oracle XE 21c x 2 (ASIS, TOBE)
   - Kafka + Zookeeper + Debezium

2. **CDC 설정**
   - Oracle LogMiner 활성화 (Archive Log, Supplemental Log)
   - Oracle JDBC 드라이버 추가
   - Debezium Oracle 커넥터 등록
   - 실시간 변경 캡처 확인

3. **DB 스키마**
   - 원본 테이블 (ASIS 4개, TOBE 4개)
   - CDC 테이블, STAGING 테이블
   - 코드 매핑 테이블

### 접속 정보

| 서비스 | URL/접속정보 |
|--------|-------------|
| ASIS Oracle | localhost:1521 / asis_user / asis123 |
| TOBE Oracle | localhost:1522 / tobe_user / tobe123 |
| Kafka UI | http://localhost:8081 |
| Kafka Connect API | http://localhost:8083 |

### 다음 단계 (TODO)

1. Sync Service 연동 테스트 (Kafka → 상대 DB CDC 테이블)
2. WORKER 프로시저 실행 테스트
3. 양방향 동기화 검증
4. 무한루프 방지 테스트

---

### [2025-01-13] 단계 8: Sync Service Java 버전 전환

**작업 내용:**
- Python Sync Service → Java/Spring Boot 버전으로 변경
- Java 개발자에게 친숙한 기술 스택으로 전환

**변경 사항:**

| 항목 | Python (이전) | Java (현재) |
|------|--------------|-------------|
| 프레임워크 | kafka-python + oracledb | Spring Boot 3.2 + Spring Kafka |
| 빌드 | pip install | Maven |
| 디렉토리 | sync-service/ | sync-service-java/ |

**생성된 파일:**
```
sync-service-java/
├── pom.xml
├── Dockerfile
└── src/main/java/com/cdc/sync/
    ├── SyncServiceApplication.java
    ├── config/
    │   ├── DataSourceConfig.java
    │   └── KafkaConfig.java
    ├── consumer/
    │   └── CdcKafkaConsumer.java
    ├── service/
    │   └── CdcSyncService.java
    └── model/
        └── CdcEvent.java
```

**docker-compose.yml 변경:**
```yaml
sync-service:
  build: ./sync-service-java
  image: poc-sync-service-java
```

**확인:**
```bash
docker logs sync-service
# Started SyncServiceApplication in 3.384 seconds
# Subscribed to topic(s): asis.ASIS_USER.*, tobe.TOBE_USER.*
```

**진행 상태:** ✅ 완료

---

### [2025-01-13] 문서 작성

**작성된 문서:**

| 문서 | 내용 |
|------|------|
| 08_CDC_PoC_종합_가이드.md | 전체 개요, 빠른 시작 |
| 08_아키텍처_상세.md | 아키텍처 설명, 왜 이렇게 구성했는지 |
| 09_설정_가이드.md | Docker, Oracle, Debezium, Java 설정 방법 |
| 10_테스트_가이드.md | 테스트 시나리오, 확인 방법 |
| 11_트러블슈팅.md | 문제 해결 가이드 |

**진행 상태:** ✅ 완료

---

### [2025-01-13] 단계 9: Sync Service Health Check 추가

**작업 내용:**
- Spring Boot Actuator 추가 (health endpoint)
- docker-compose.yml에 healthcheck 설정
- 다른 컨테이너들과 일관성 있는 상태 표시

**변경된 파일:**

| 파일 | 변경 내용 |
|------|----------|
| pom.xml | spring-boot-starter-actuator, spring-boot-starter-web 추가 |
| application.yml | management.endpoints 설정, server.port 8080 |
| Dockerfile | curl 설치, EXPOSE 8080 |
| docker-compose.yml | healthcheck 설정, 포트 8082:8080 노출 |

**Health Check 설정:**
```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
  interval: 30s
  timeout: 10s
  retries: 5
  start_period: 60s
```

**결과:**
```
sync-service   poc-sync-service-java   Up About a minute (healthy)   0.0.0.0:8082->8080/tcp
```

**접속 정보:**
- Health Endpoint: http://localhost:8082/actuator/health

**진행 상태:** ✅ 완료

---

### [2025-01-13] 단계 10: Sync Service 버그 수정 및 테스트

**발견된 문제:**

| 문제 | 원인 | 해결 |
|------|------|------|
| DB 연결 실패 | HikariCP가 `jdbc-url` 필요 | application.yml에서 `url` → `jdbc-url` 변경 |
| ORA-00932 타입 오류 | Debezium이 DATE를 epoch ms로 전송 | `convertEpochToTimestamp()` 메서드 추가 |

**수정된 파일:**

| 파일 | 변경 내용 |
|------|----------|
| application.yml | `url` → `jdbc-url` 변경 |
| CdcSyncService.java | DATE/TIMESTAMP 컬럼 변환 로직 추가 |

**테스트 결과:**

```sql
-- ASIS DB에서 UPDATE 실행
UPDATE BOOK_INFO SET BOOK_TITLE = 'CDC성공테스트' WHERE BOOK_ID = 3;
COMMIT;

-- TOBE DB에서 CDC 테이블 확인
SELECT * FROM CDC_TOBE_BOOK;
-- 결과: UPDATE 이벤트가 정상적으로 INSERT됨
```

**CDC 흐름 검증:**
```
ASIS DB (UPDATE) → Debezium → Kafka → Sync Service → TOBE CDC 테이블 ✅
```

**진행 상태:** ✅ 완료

---

### [2025-01-13] 단계 11: 모니터링 대시보드 구현

**작업 내용:**
- 웹 기반 모니터링 대시보드 구현
- REST API 모니터링 엔드포인트 추가
- 성공/실패 케이스 시각화

**생성된 파일:**

| 파일 | 역할 |
|------|------|
| CdcMonitoringService.java | 통계 수집 및 관리 |
| MonitoringController.java | REST API 엔드포인트 |
| DashboardController.java | HTML 대시보드 페이지 |

**주요 기능:**

| 기능 | 설명 |
|------|------|
| 실시간 통계 | 총 수신/성공/실패/성공률 |
| 토픽별 통계 | 각 토픽별 처리 현황 |
| 최근 이벤트 | 최근 50개 이벤트 로그 |
| 최근 에러 | 최근 100개 에러 로그 |
| 자동 새로고침 | 5초마다 대시보드 업데이트 |

**접속 정보:**

| 서비스 | URL |
|--------|-----|
| 대시보드 | http://localhost:8082/dashboard |
| 통계 API | http://localhost:8082/api/monitoring/stats |
| 이벤트 API | http://localhost:8082/api/monitoring/events |
| 에러 API | http://localhost:8082/api/monitoring/errors |

**진행 상태:** ✅ 완료

---

---

