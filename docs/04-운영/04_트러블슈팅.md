# 트러블슈팅

> **목표**: CDC PoC 환경에서 발생하는 문제와 해결 방법을 안내합니다.
>
> **타임라인**: 각 문제에는 발생 시점이 기록되어 있습니다.

---

## 트러블슈팅 타임라인

| 날짜 | 시점 | 문제/작업 | 섹션 |
|------|------|------|:----:|
| 2026-01-13 | 초기 환경 구축 | 포트 충돌 (1521, 1522) | 1.1 |
| 2026-01-13 | Debezium 연동 | ARCHIVELOG 모드 미활성화 | 11.2 |
| 2026-01-13 | Debezium 연동 | c##dbzuser 미생성 | 11.2 |
| 2026-01-13 | 커넥터 등록 | CONTINUOUS_MINE 미지원 오류 | 2.2 |
| 2026-01-13 | 프로시저 컴파일 | SQLERRM invalid identifier | 9.1 |
| 2026-01-14 | Docker 재시작 후 | 프로시저 INVALID (볼륨에 이전 코드) | 9.2 |
| 2026-01-14 | TOBE→ASIS 동기화 | CDC_ASIS_BOOK 컬럼 누락 | 10.2 |
| 2026-01-14 | TOBE→ASIS 동기화 | CDC_ASIS_MEMBER 컬럼 누락 | 10.2 |
| 2026-01-14 | 프로시저 재생성 | STAGING 컬럼명 불일치 (NEW_SERVICE) | 10.3 |
| 2026-01-14 | 자동화 작업 | **Debezium 설정 자동화 스크립트 구현** | 12 |

---

## 1. 컨테이너 문제

### 1.1 Oracle 컨테이너가 시작되지 않음

**증상:**
```
docker compose ps
# asis-oracle이 Exited 상태
```

**원인 1: 메모리 부족**

```bash
# 로그 확인
docker logs asis-oracle

# "Out of memory" 또는 "Cannot allocate memory" 메시지
```

**해결:**
1. Docker Desktop → Settings → Resources
2. Memory를 최소 4GB 이상으로 설정
3. 컨테이너 재시작: `docker compose restart asis-oracle`

**원인 2: 포트 충돌**

```bash
# 로그에서 "Address already in use" 확인
netstat -ano | findstr "1521"
```

**해결:**
```yaml
# docker-compose.yml에서 포트 변경
ports:
  - "1523:1521"  # 다른 포트 사용
```

### 1.2 Kafka Connect가 시작되지 않음

**증상:**
```bash
curl http://localhost:8083/connectors
# 연결 거부
```

**원인: Kafka 미준비 상태에서 시작**

**해결:**
```bash
# Kafka 상태 확인
docker logs kafka | tail -20

# Kafka Connect 재시작
docker compose restart kafka-connect

# 또는 순차적으로 시작
docker compose up -d zookeeper
sleep 10
docker compose up -d kafka
sleep 20
docker compose up -d kafka-connect
```

---

## 2. Debezium 커넥터 문제

### 2.1 커넥터 FAILED 상태

**증상:**
```bash
curl http://localhost:8083/connectors/asis-oracle-connector/status
# "state": "FAILED"
```

**확인 방법:**
```bash
# 에러 메시지 확인
curl -s http://localhost:8083/connectors/asis-oracle-connector/status | jq '.tasks[0].trace'
```

---

### 2.2 ORA-44609: CONTINUOUS_MINE is desupported

**증상:**
```
java.sql.SQLException: ORA-44609: CONTINOUS_MINE is desupported for use with DBMS_LOGMNR.START_LOGMNR.
```

**원인:** Oracle 19c부터 CONTINUOUS_MINE 옵션 제거됨

**해결:**
```bash
# 커넥터 삭제
curl -X DELETE http://localhost:8083/connectors/asis-oracle-connector

# continuous_mine 옵션 없이 재등록
curl -X POST http://localhost:8083/connectors \
  -H "Content-Type: application/json" \
  -d '{
    "name": "asis-oracle-connector",
    "config": {
      "connector.class": "io.debezium.connector.oracle.OracleConnector",
      ...
      "log.mining.strategy": "online_catalog"
      // "log.mining.continuous.mine": "true"  ← 이 옵션 제거
    }
  }'
```

---

### 2.3 No suitable driver found for jdbc:oracle

**증상:**
```
java.sql.SQLException: No suitable driver found for jdbc:oracle:thin:@asis-oracle:1521/XE
```

**원인:** Oracle JDBC 드라이버 미설치

**해결:**
```bash
# 1. 드라이버 다운로드
curl -L -o poc/kafka-connect/libs/ojdbc11.jar \
  "https://repo1.maven.org/maven2/com/oracle/database/jdbc/ojdbc11/23.3.0.23.09/ojdbc11-23.3.0.23.09.jar"

# 2. docker-compose.yml 확인
kafka-connect:
  volumes:
    - ./kafka-connect/libs/ojdbc11.jar:/kafka/libs/ojdbc11.jar

# 3. 컨테이너 재시작
docker compose up -d kafka-connect
```

---

### 2.4 ORA-01031: insufficient privileges

**증상:**
```
ORA-01031: insufficient privileges
```

**원인:** LogMiner 권한 부족

**해결:**
```sql
-- sysdba로 접속
docker exec -i asis-oracle bash -c 'export ORACLE_SID=XE && sqlplus / as sysdba'

-- 누락된 권한 부여
GRANT LOGMINING TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ON V_$LOGMNR_CONTENTS TO c##dbzuser CONTAINER=ALL;
GRANT EXECUTE ON DBMS_LOGMNR TO c##dbzuser CONTAINER=ALL;
```

---

### 2.5 테이블이 캡처되지 않음

**증상:** 데이터 변경해도 Kafka 토픽에 메시지 없음

**확인 1: 테이블 목록**
```bash
curl -s http://localhost:8083/connectors/asis-oracle-connector/config | jq '.["table.include.list"]'
```

**확인 2: Supplemental Logging**
```sql
-- 테이블 레벨 supplemental logging 확인
SELECT LOG_GROUP_NAME, TABLE_NAME, ALWAYS
FROM DBA_LOG_GROUPS
WHERE OWNER = 'ASIS_USER';

-- 활성화
ALTER TABLE ASIS_USER.BOOK_INFO ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;
```

**확인 3: 커넥터 재시작**
```bash
curl -X POST http://localhost:8083/connectors/asis-oracle-connector/restart
```

---

## 3. Sync Service 문제

### 3.1 DB 연결 실패

**증상:**
```
docker logs sync-service
# Connection refused 또는 Connection timed out
```

**해결:**
```bash
# 1. Oracle 컨테이너 상태 확인
docker exec asis-oracle healthcheck.sh

# 2. 네트워크 연결 테스트
docker exec sync-service ping -c 2 asis-oracle

# 3. 환경변수 확인
docker exec sync-service env | grep DB

# 4. 재시작
docker compose restart sync-service
```

### 3.2 Kafka 연결 실패

**증상:**
```
NoBrokersAvailable
```

**해결:**
```bash
# 1. Kafka 상태 확인
docker logs kafka | tail -20

# 2. 네트워크 테스트
docker exec sync-service nc -zv kafka 29092

# 3. 환경변수 확인 (kafka:29092 여야 함)
docker exec sync-service env | grep KAFKA

# 4. Sync Service 재시작 (Kafka 완전 시작 후)
docker compose restart sync-service
```

### 3.3 메시지 처리 에러

**증상:**
```
Failed to parse Debezium message
```

**확인:**
```bash
# 상세 로그 확인
docker logs sync-service 2>&1 | grep -A5 "Failed to parse"
```

**해결:** Debezium 메시지 형식 확인 후 파서 수정

---

## 4. 데이터 문제

### 4.1 CDC 테이블에 데이터가 안 들어옴

**확인 순서:**

```bash
# 1. 커넥터 상태
curl http://localhost:8083/connectors/asis-oracle-connector/status

# 2. Kafka 토픽에 메시지 있는지
docker exec kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic asis.ASIS_USER.BOOK_INFO \
  --from-beginning --max-messages 1

# 3. Sync Service 로그
docker logs sync-service | tail -50

# 4. Consumer 그룹 상태
docker exec kafka kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --describe --group cdc-sync-service
```

### 4.2 스키마 변환 오류

**증상:** CDC 테이블에 데이터는 있지만 WORKER 실패

**확인:**
```sql
-- 에러 메시지 확인
SELECT CDC_SEQ, ERROR_MSG
FROM CDC_TOBE_BOOK
WHERE PROCESSED_YN = 'E';
```

**해결:**
1. 코드 매핑 테이블 확인 (CODE_MAPPING)
2. 누락된 매핑 추가
3. WORKER 재실행

### 4.3 무한루프 발생

**증상:** 같은 데이터가 계속 동기화됨

**확인:**
```sql
-- 동일 해시 확인
SELECT CHANGE_HASH, COUNT(*)
FROM CDC_TOBE_BOOK
GROUP BY CHANGE_HASH
HAVING COUNT(*) > 1;
```

**해결:**
1. CHANGE_HASH 기반 중복 체크 로직 확인
2. WORKER의 FN_IS_LOOP 함수 확인
3. HASH_LOG 테이블 데이터 확인

---

## 5. 성능 문제

### 5.1 동기화 지연

**증상:** 변경 후 CDC 테이블에 나타나기까지 오래 걸림

**확인:**
```bash
# Consumer Lag 확인
docker exec kafka kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --describe --group cdc-sync-service
```

**해결:**
1. Sync Service 인스턴스 증가
2. Kafka 파티션 증가
3. DB 커넥션 풀 조정

### 5.2 메모리 부족

**증상:**
```
java.lang.OutOfMemoryError
```

**해결:**
```yaml
# docker-compose.yml
sync-service:
  environment:
    JAVA_OPTS: "-Xms512m -Xmx1024m"
```

---

## 6. 로그 확인 명령어 모음

```bash
# 전체 컨테이너 상태
docker compose ps

# 각 컨테이너 로그
docker logs asis-oracle --tail 50
docker logs tobe-oracle --tail 50
docker logs kafka --tail 50
docker logs kafka-connect --tail 50
docker logs sync-service --tail 50

# 실시간 로그 (Ctrl+C로 종료)
docker logs -f sync-service

# 특정 문자열 검색
docker logs sync-service 2>&1 | grep -i error
docker logs kafka-connect 2>&1 | grep -i exception

# 커넥터 상태
curl -s http://localhost:8083/connectors | jq
curl -s http://localhost:8083/connectors/asis-oracle-connector/status | jq
```

---

## 7. 전체 환경 초기화

문제 해결이 어려울 때 처음부터 다시 시작:

```bash
# 1. 모든 컨테이너 및 볼륨 삭제
docker compose down -v

# 2. 이미지 캐시 정리 (선택)
docker system prune -f

# 3. 다시 시작
docker compose up -d

# 4. Oracle 준비 대기 (약 2-3분)
docker logs -f asis-oracle

# 5. LogMiner 설정 (문서 참조)

# 6. 커넥터 등록 (문서 참조)
```

---

## 8. 도움 요청 시 수집할 정보

문제 해결이 안 될 때 다음 정보를 수집하세요:

```bash
# 1. 컨테이너 상태
docker compose ps > container_status.txt

# 2. 각 서비스 로그
docker logs asis-oracle > asis_oracle.log 2>&1
docker logs kafka-connect > kafka_connect.log 2>&1
docker logs sync-service > sync_service.log 2>&1

# 3. 커넥터 상태
curl -s http://localhost:8083/connectors/asis-oracle-connector/status > connector_status.json

# 4. 환경 정보
docker version > docker_version.txt
```

---

---

## 9. PL/SQL 프로시저 문제

### 9.1 SQLERRM invalid identifier

> **발생 시점**: 2026-01-13 / Oracle Scheduler Job 추가 후 프로시저 컴파일 시

**증상:**
```
PL/SQL: ORA-00904: "SQLERRM": invalid identifier
```

**SQLERRM이란?**
Oracle PL/SQL에서 예외 발생 시 에러 메시지를 반환하는 내장 함수입니다.

**원인:**
SQLERRM은 **PL/SQL 컨텍스트에서만 사용 가능**하고, SQL 문(UPDATE, INSERT 등) 내부에서는 직접 사용할 수 없습니다.

```sql
-- ❌ 잘못된 코드 (SQL문 내부에서 직접 사용)
EXCEPTION
    WHEN OTHERS THEN
        UPDATE CDC_TOBE_BOOK
        SET ERROR_MSG = SUBSTR(SQLERRM, 1, 500)  -- 오류!
        WHERE CDC_SEQ = rec.CDC_SEQ;
```

**해결:**
SQLERRM을 먼저 변수에 저장한 후 사용합니다.

```sql
-- ✅ 올바른 코드
IS
    v_err_msg VARCHAR2(500);  -- 변수 선언
BEGIN
    -- ...
EXCEPTION
    WHEN OTHERS THEN
        v_err_msg := SUBSTR(SQLERRM, 1, 500);  -- 변수에 저장
        UPDATE CDC_TOBE_BOOK
        SET ERROR_MSG = v_err_msg  -- 변수 사용
        WHERE CDC_SEQ = rec.CDC_SEQ;
```

**수정 대상 프로시저:**
- TOBE: SP_WORKER_BOOK, SP_WORKER_MEMBER, SP_WORKER_LEGACY_CODE
- ASIS: SP_WORKER_BOOK, SP_WORKER_MEMBER, SP_WORKER_NEW_SERVICE

> **핵심**: PL/SQL 내장 함수(SQLERRM, SQLCODE 등)는 SQL 문 내부에서 직접 사용할 수 없습니다. 반드시 변수에 먼저 저장하세요.

### 9.2 프로시저 INVALID 상태

> **발생 시점**: 2026-01-14 / Docker 재시작 후 테이블/프로시저 확인 시
> **원인 배경**: 2026-01-13에 init 스크립트 수정했으나, 볼륨이 이미 존재하여 새 스크립트 미적용

**증상:**
```sql
SELECT object_name, status FROM user_objects WHERE object_type = 'PROCEDURE';
-- SP_WORKER_BOOK  INVALID
```

**원인:**
- init 스크립트에 버그가 있음
- Docker 볼륨에 이전 버전 코드가 남아있음

**해결:**
```bash
# 프로시저 수동 재생성
docker exec tobe-oracle sqlplus tobe_user/tobe123@//localhost:1521/XEPDB1

# 또는 볼륨 삭제 후 재시작 (데이터 손실 주의!)
docker-compose down -v
docker-compose up -d
```

---

## 10. 구/신 시스템 스키마 차이 문제

### 10.1 배경: 왜 스키마가 다른가?

ASIS(기존 CLIMS)와 TOBE(미래통합관리시스템)는 **표준화 작업**으로 인해 스키마가 다릅니다:

| 차이 유형 | ASIS 예시 | TOBE 예시 |
|----------|----------|----------|
| 컬럼명 변경 | BOOK_TITLE | TITLE |
| 코드값 변경 | STATUS (Y/N) | IS_ACTIVE (1/0) |
| 컬럼 추가 | - | CREATED_BY, UPDATED_BY |
| 타입 변경 | REG_DATE (DATE) | CREATED_AT (TIMESTAMP) |

### 10.2 CDC 테이블 컬럼 누락 오류

> **발생 시점**: 2026-01-14 / TOBE→ASIS 방향 동기화 테스트 시
> **상황**: TOBE에서 INSERT 후 Sync Service가 CDC_ASIS_BOOK에 저장 시도

**증상:**
```
ORA-00904: "UPDATED_AT": invalid identifier
```

**원인:**
TOBE에서 ASIS로 데이터 전송 시, TOBE에만 있는 컬럼(CREATED_AT, UPDATED_AT 등)도 전송됩니다. CDC_ASIS_* 테이블에 해당 컬럼이 없으면 INSERT 실패합니다.

**해결:**
CDC 테이블에 상대방 시스템의 모든 컬럼을 추가합니다.

```sql
-- CDC_ASIS_BOOK에 TOBE 전용 컬럼 추가
ALTER TABLE CDC_ASIS_BOOK ADD (
    CREATED_AT TIMESTAMP,
    UPDATED_AT TIMESTAMP,
    CREATED_BY VARCHAR2(50),
    UPDATED_BY VARCHAR2(50)
);

-- CDC_ASIS_MEMBER에 TOBE 전용 컬럼 추가
ALTER TABLE CDC_ASIS_MEMBER ADD (
    CREATED_AT TIMESTAMP,
    UPDATED_AT TIMESTAMP
);
```

> **핵심**: CDC 테이블은 **상대방 시스템의 모든 컬럼을 수용**할 수 있어야 합니다.

### 10.3 STAGING/원본 테이블 컬럼명 불일치

> **발생 시점**: 2026-01-14 / ASIS SP_WORKER_NEW_SERVICE 프로시저 생성 시
> **상황**: CDC 테이블 컬럼명과 STAGING/원본 테이블 컬럼명이 다름

**증상:**
```
PLS-00302: component 'SERVICE_TYPE' must be declared
```

**원인:**
CDC 테이블과 STAGING/원본 테이블의 컬럼명이 다릅니다.

| CDC (TOBE에서 수신) | STAGING/원본 (ASIS) |
|--------------------|---------------------|
| SERVICE_NAME | SERVICE_NM |
| SERVICE_TYPE_CD | SVC_TYPE |
| IS_ACTIVE (1/0) | USE_YN (Y/N) |

**해결:**
프로시저에서 컬럼 매핑을 적용합니다.

```sql
-- SP_WORKER_NEW_SERVICE (ASIS)
INSERT INTO STAGING_ASIS_NEW_SERVICE (
    SERVICE_NM,    -- ASIS 컬럼명
    SVC_TYPE,      -- ASIS 컬럼명
    USE_YN         -- ASIS 컬럼명
) VALUES (
    rec.SERVICE_NAME,     -- CDC 컬럼 (TOBE에서 수신)
    rec.SERVICE_TYPE_CD,  -- CDC 컬럼 (TOBE에서 수신)
    CASE rec.IS_ACTIVE WHEN 1 THEN 'Y' ELSE 'N' END  -- 값 변환
);
```

### 10.4 테이블 역할 정리

```
┌─────────────────────────────────────────────────────────────────┐
│ [CDC 테이블]                                                      │
│ - 상대방 시스템에서 전송받은 원본 데이터 저장                        │
│ - 상대방 스키마 그대로 저장 (변환 없음)                              │
│ - 예: CDC_TOBE_BOOK은 ASIS 스키마(BOOK_TITLE, AUTHOR 등)          │
├─────────────────────────────────────────────────────────────────┤
│ [STAGING 테이블]                                                  │
│ - 스키마 변환 후 임시 저장                                         │
│ - 자기 시스템 스키마로 변환됨                                       │
│ - 예: STAGING_TOBE_BOOK은 TOBE 스키마(TITLE, AUTHOR_NAME 등)      │
├─────────────────────────────────────────────────────────────────┤
│ [원본 테이블]                                                      │
│ - 최종 동기화 대상                                                 │
│ - 실제 업무에서 사용하는 테이블                                     │
│ - 예: TB_BOOK, BOOK_INFO                                         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 11. Debezium 수동 설정 문제

> **발생 시점**: 2026-01-13 / Debezium 커넥터 등록 후 FAILED 상태 확인 시
> **상황**: 커넥터가 Oracle LogMiner에 접근하지 못함

### 11.1 설정이 필요한 이유

Debezium Oracle 커넥터가 LogMiner를 사용하려면 **특별한 설정**이 필요합니다. 이 설정들은 Oracle XE Docker 이미지 기본값에 포함되어 있지 않습니다.

| 설정 | 설명 | 필요 이유 |
|------|------|----------|
| ARCHIVELOG 모드 | Oracle 로그 아카이브 활성화 | LogMiner가 redo log를 읽으려면 필수 |
| Supplemental Logging | 변경 전/후 값 기록 | CDC가 변경 데이터 캡처에 필수 |
| c##dbzuser 사용자 | Debezium 전용 DB 사용자 | LogMiner 접근 권한 |

### 11.2 현재 방식: 수동 실행

```bash
# 1. Docker 시작
cd poc && docker-compose up -d

# 2. Oracle healthy 대기 (1-2분)
docker-compose ps

# 3. Debezium 설정 실행
./scripts/setup-debezium-oracle.sh

# 4. 커넥터 등록
./scripts/register-connectors.sh
```

### 11.3 자동화 방법 1: Docker 이미지 커스텀 빌드

Oracle XE 이미지를 확장하여 설정 포함 이미지를 빌드합니다.

**Dockerfile 작성:**
```dockerfile
# poc/oracle-debezium/Dockerfile
FROM gvenzl/oracle-xe:21-slim
ENV ORACLE_PASSWORD=oracle
COPY setup-archivelog.sh /opt/oracle/scripts/startup/
COPY setup-dbzuser.sql /opt/oracle/scripts/setup/
RUN chmod +x /opt/oracle/scripts/startup/setup-archivelog.sh
```

**docker-compose.yml 수정:**
```yaml
services:
  asis-oracle:
    build:
      context: ./oracle-debezium
      dockerfile: Dockerfile
```

**빌드 및 실행:**
```bash
docker-compose build asis-oracle tobe-oracle
docker-compose up -d
```

### 11.4 자동화 방법 2: 별도 설정 서비스

docker-compose에 Oracle healthy 후 자동 실행되는 서비스를 추가합니다.

```yaml
services:
  # Oracle 서비스들...

  debezium-setup:
    image: docker:latest
    depends_on:
      asis-oracle:
        condition: service_healthy
      tobe-oracle:
        condition: service_healthy
    volumes:
      - ./scripts:/scripts
      - /var/run/docker.sock:/var/run/docker.sock
    command: >
      sh -c "
        echo 'Debezium 설정 시작...';
        docker exec asis-oracle bash -c 'sqlplus / as sysdba @/scripts/setup.sql';
        docker exec tobe-oracle bash -c 'sqlplus / as sysdba @/scripts/setup.sql';
        echo 'Debezium 설정 완료!';
      "
    restart: "no"
```

### 11.5 권장 방법

| 상황 | 권장 방법 |
|------|----------|
| 개발/테스트 | 수동 실행 (간단) |
| CI/CD | 커스텀 이미지 빌드 |
| 데모/교육 | 별도 설정 서비스 |

---

## 12. Debezium 설정 자동화 (구현 완료)

> **작성일**: 2026-01-14

### 12.1 개요

기존 수동 설정의 불편함을 해결하기 위해 **통합 시작 스크립트**를 구현했습니다.

### 12.2 사용법

```bash
# 전체 환경 시작 (Linux/Mac/Git Bash)
cd poc
./scripts/start-all.sh

# Windows
scripts\start-all.bat
```

### 12.3 스크립트 설명

| 스크립트 | 역할 |
|----------|------|
| `start-all.sh` | 통합 시작 (docker-compose + 설정 + 커넥터) |
| `setup-debezium-oracle.sh` | Oracle 설정 (ARCHIVELOG, c##dbzuser, Supplemental Logging) |
| `register-connectors.sh` | Debezium 커넥터 등록/재등록 |

### 12.4 멱등성

스크립트는 **이미 설정된 경우 건너뛰기** 기능이 있어 반복 실행해도 안전합니다:

```
[asis-oracle]
  현재 상태: LOG_MODE=ARCHIVELOG, c##dbzuser=1명
  ARCHIVELOG 모드: 이미 설정됨 (SKIP)
  c##dbzuser: 이미 존재함 (SKIP)
```

### 12.5 주의사항

- **볼륨 삭제** (`docker-compose down -v`) 후에만 재설정 필요
- 일반 재시작(`docker-compose restart`)에서는 설정 유지됨
- Git Bash 또는 WSL 필요 (Windows)

---

> **문서 끝** - 문제가 해결되지 않으면 구축 로그([07_CDC_PoC_구축_로그.md](07_CDC_PoC_구축_로그.md))를 참조하세요.
