# 모니터링 및 시뮬레이터

> **목표**: CDC 동기화 시뮬레이터와 모니터링 도구 사용법을 안내합니다.

---

## 1. 시뮬레이터 접속

### 1.1 웹 시뮬레이터

| URL | 설명 |
|-----|------|
| **http://localhost:8082/simulator** | 메인 시뮬레이터 (기본: BOOK 테이블) |
| http://localhost:8082/simulator?table=MEMBER | 테이블 지정 접속 |
| ~~http://localhost:8082/dashboard~~ | 기존 URL → `/simulator`로 자동 리다이렉트 |

### 1.2 화면 구성 (3개 탭)

```
┌─────────────────────────────────────────────────────────────────┐
│  CDC 동기화 시뮬레이터           [테이블: BOOK ▼] [↔ 양방향]    │
├─────────────────────────────────────────────────────────────────┤
│  [테스트 실행]  [동기화 흐름]  [이력/통계]                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────┐    ┌───────────────────────┐        │
│  │ ASIS에서 테스트 (구→신) │    │ TOBE에서 테스트 (신→구) │        │
│  │ 테이블: BOOK_INFO     │    │ 테이블: TB_BOOK        │        │
│  │                       │    │                        │        │
│  │ [도서ID] [제목]       │    │ [도서ID] [제목]        │        │
│  │ [INSERT][UPDATE][DEL] │    │ [INSERT][UPDATE][DEL]  │        │
│  └───────────────────────┘    └───────────────────────┘        │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ASIS 원본 테이블 (BOOK_INFO)  │  TOBE 원본 테이블 (TB_BOOK)│   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 지원 테이블 및 동기화 방향

| 테이블 | 표시명 | 방향 | ASIS 원본 | TOBE 원본 |
|--------|--------|:----:|-----------|-----------|
| BOOK | 도서 | ↔ | BOOK_INFO | TB_BOOK |
| MEMBER | 회원 | ↔ | MEMBER_INFO | TB_MEMBER |
| LEGACY_CODE | 레거시코드 | → | LEGACY_CODE | TB_LEGACY_CODE |
| NEW_SERVICE | 신규서비스 | ← | NEW_SERVICE_RECV | TB_NEW_SERVICE |

> **방향 범례**: ↔ 양방향, → 구→신, ← 신→구

### 1.4 탭별 기능

| 탭 | 기능 |
|------|------|
| **테스트 실행** | CUD 테스트 버튼, 동적 입력 폼, 원본 테이블 조회 |
| **동기화 흐름** | 원본→CDC→STAGING→대상 4단계 흐름 추적 |
| **이력/통계** | CDC_SYNC_LOG 조회, 성공/실패/루프차단 통계 |

---

## 2. REST API 엔드포인트

### 2.1 시뮬레이터 API (신규)

#### 원본/CDC/STAGING 테이블 조회

```bash
# 원본 테이블 조회
curl http://localhost:8082/api/simulator/BOOK/asis/data
curl http://localhost:8082/api/simulator/BOOK/tobe/data

# CDC 테이블 조회
curl http://localhost:8082/api/simulator/BOOK/asis/cdc
curl http://localhost:8082/api/simulator/BOOK/tobe/cdc

# STAGING 테이블 조회
curl http://localhost:8082/api/simulator/BOOK/asis/staging
curl http://localhost:8082/api/simulator/BOOK/tobe/staging
```

**응답 예시:**
```json
{
  "success": true,
  "table": "BOOK_INFO",
  "db": "ASIS",
  "count": 5,
  "data": [
    { "BOOK_ID": 1, "BOOK_TITLE": "도서1", "AUTHOR": "저자1", "STATUS": "Y" }
  ]
}
```

#### CUD 테스트 실행

```bash
# INSERT 테스트
curl -X POST http://localhost:8082/api/simulator/BOOK/asis/insert \
  -H "Content-Type: application/json" \
  -d '{"BOOK_TITLE": "신규도서", "AUTHOR": "테스트저자"}'

# UPDATE 테스트
curl -X POST http://localhost:8082/api/simulator/BOOK/asis/update \
  -H "Content-Type: application/json" \
  -d '{"BOOK_ID": 1, "BOOK_TITLE": "수정된제목"}'

# DELETE 테스트
curl -X POST http://localhost:8082/api/simulator/BOOK/asis/delete \
  -H "Content-Type: application/json" \
  -d '{"BOOK_ID": 5}'
```

**응답 예시:**
```json
{
  "success": true,
  "operation": "INSERT",
  "message": "ASIS DB INSERT 완료",
  "table": "BOOK_INFO",
  "sql": "INSERT INTO BOOK_INFO (...) VALUES (...)",
  "insertedData": { "BOOK_ID": 6, "BOOK_TITLE": "신규도서", ... },
  "rowsAffected": 1,
  "targetCdcTable": "CDC_TOBE_BOOK"
}
```

#### 동기화 로그 조회

```bash
curl "http://localhost:8082/api/simulator/sync-log?table=BOOK"
```

**응답:**
```json
{
  "success": true,
  "count": 10,
  "data": [
    {
      "LOG_SEQ": 1,
      "LOG_TIME": "2026-01-14T10:30:00",
      "DIRECTION": "ASIS_TO_TOBE",
      "TABLE_NAME": "TB_BOOK",
      "OPERATION": "INSERT",
      "PK_VALUE": "6",
      "STATUS": "SUCCESS",
      "SOURCE_DB": "TOBE"
    }
  ]
}
```

#### 통계 조회

```bash
curl "http://localhost:8082/api/simulator/stats?table=BOOK"
```

**응답:**
```json
{
  "success": true,
  "stats": {
    "asis": [{ "STATUS": "SUCCESS", "CNT": 10 }],
    "tobe": [{ "STATUS": "SUCCESS", "CNT": 8 }, { "STATUS": "BLOCKED", "CNT": 2 }]
  }
}
```

### 2.2 기존 모니터링 API (유지)

```bash
# 전체 통계
curl http://localhost:8082/api/monitoring/stats

# 최근 이벤트
curl http://localhost:8082/api/monitoring/events

# 최근 에러
curl http://localhost:8082/api/monitoring/errors

# 통합 대시보드 데이터
curl http://localhost:8082/api/monitoring/dashboard

# 통계 초기화
curl -X POST http://localhost:8082/api/monitoring/reset
```

---

## 3. 모니터링 해석 방법

### 3.1 정상 상태

```
총 수신: 100  │  성공: 100  │  실패: 0  │  성공률: 100%
```

- 성공률 100%
- 에러 목록 비어있음
- 모든 이벤트가 SUCCESS 상태

### 3.2 문제 상태

```
총 수신: 100  │  성공: 85  │  실패: 15  │  성공률: 85%
```

**확인 순서:**

1. **에러 메시지 확인**
   ```bash
   curl http://localhost:8082/api/monitoring/errors | python -m json.tool
   ```

2. **에러 유형별 대응**

   | 에러 메시지 | 원인 | 해결 |
   |------------|------|------|
   | ORA-00942 table not found | CDC 테이블 없음 | 초기화 SQL 실행 |
   | ORA-00932 datatypes | 타입 불일치 | 코드 수정 필요 |
   | Connection refused | DB 연결 불가 | Oracle 컨테이너 확인 |

3. **Sync Service 로그 확인**
   ```bash
   docker logs sync-service --tail 50 | grep ERROR
   ```

### 3.3 토픽별 상태 분석

```json
"tableStats": {
  "asis.ASIS_USER.BOOK_INFO": {
    "received": 50,
    "success": 50,
    "failed": 0
  },
  "asis.ASIS_USER.MEMBER_INFO": {
    "received": 30,
    "success": 15,
    "failed": 15
  }
}
```

- BOOK_INFO: 정상 (100% 성공)
- MEMBER_INFO: 문제 있음 (50% 실패)
  → MEMBER_INFO 관련 에러 메시지 확인 필요

---

## 4. 모니터링 시나리오

### 4.1 성공 케이스 확인

**1단계: ASIS DB에서 UPDATE 실행**
```sql
UPDATE BOOK_INFO SET BOOK_TITLE = '테스트' WHERE BOOK_ID = 1;
COMMIT;
```

**2단계: 대시보드에서 확인**
- 총 수신: +1
- 성공: +1
- 최근 이벤트에 SUCCESS 행 추가

**3단계: API로 확인**
```bash
curl http://localhost:8082/api/monitoring/stats
# successRate가 유지되거나 증가
```

### 4.2 실패 케이스 확인

**1단계: CDC 테이블 삭제 (의도적 에러 유발)**
```sql
-- TOBE DB에서 실행
DROP TABLE CDC_TOBE_BOOK;
```

**2단계: ASIS DB에서 UPDATE 실행**
```sql
UPDATE BOOK_INFO SET BOOK_TITLE = '에러테스트' WHERE BOOK_ID = 1;
COMMIT;
```

**3단계: 대시보드에서 확인**
- 총 수신: +1
- 실패: +1
- 최근 에러에 새 행 추가
- 에러 메시지: "ORA-00942: table or view does not exist"

**4단계: 테이블 복구 후 정상화 확인**
```sql
-- CDC 테이블 재생성
-- (초기화 SQL 다시 실행)
```

### 4.3 실시간 모니터링

```bash
# 터미널에서 5초마다 통계 출력
while true; do
  clear
  echo "=== CDC 모니터링 $(date) ==="
  curl -s http://localhost:8082/api/monitoring/stats | python -m json.tool
  sleep 5
done
```

---

## 5. Kafka UI와 함께 사용하기

### 5.1 접속 정보

| 도구 | URL | 용도 |
|------|-----|------|
| CDC 대시보드 | http://localhost:8082/dashboard | 처리 결과 모니터링 |
| Kafka UI | http://localhost:8081 | 메시지/토픽 모니터링 |

### 5.2 함께 보면 좋은 항목

```
Kafka UI                          CDC 대시보드
┌──────────────────────┐          ┌──────────────────────┐
│ Topics               │          │ 최근 이벤트          │
│ - 메시지 수          │    →     │ - 처리 결과          │
│ - Consumer Lag       │          │ - 성공/실패 상태     │
├──────────────────────┤          ├──────────────────────┤
│ Connectors           │          │ 통계                 │
│ - 상태 (RUNNING)     │    →     │ - 성공률             │
└──────────────────────┘          └──────────────────────┘
```

**문제 진단 흐름:**

1. Kafka UI에서 메시지가 토픽에 있는지 확인
2. CDC 대시보드에서 처리 결과 확인
3. 실패 시 에러 메시지로 원인 파악

---

## 6. 접속 정보 요약

| 서비스 | URL | 설명 |
|--------|-----|------|
| **CDC 시뮬레이터** | http://localhost:8082/simulator | 메인 테스트 화면 |
| 시뮬레이터 (테이블 지정) | http://localhost:8082/simulator?table=MEMBER | 특정 테이블 |
| 시뮬레이터 API | http://localhost:8082/api/simulator/* | 동적 테이블 API |
| 모니터링 API | http://localhost:8082/api/monitoring/* | 기존 모니터링 |
| Health Check | http://localhost:8082/actuator/health | 헬스체크 |
| Kafka UI | http://localhost:8081 | Kafka 토픽/메시지 |

---

## 7. 변경 이력

| 날짜 | 변경 내용 |
|------|----------|
| 2026-01-13 | 초안 작성 (모니터링 대시보드) |
| 2026-01-14 | **시뮬레이터로 전환**, Thymeleaf 적용, 동적 테이블 지원 |
| 2026-01-14 | 문서 현행화 (삭제된 파일 반영, 링크 수정) |

---

> **관련 문서:**
> - [02_소스_상세설명.md](../부록/02_소스_상세설명.md) - 소스 레벨 설명
> - [02_테스트_시나리오.md](02_테스트_시나리오.md) - 테스트 가이드
> - [03_대시보드_계획.md](../03-구현/03_대시보드_계획.md) - 시뮬레이터 개선 계획
