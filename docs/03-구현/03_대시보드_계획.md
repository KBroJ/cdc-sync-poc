# 대시보드 개선 계획

> **목표**: CDC 동기화 시뮬레이터 대시보드 구현 계획을 설명합니다.
>
> **상태**: 완료

---

## 1. 개요

### 1.1 배경
- ~~이전 `dashboard.html`은 "CDC 모니터링 대시보드"로 명명~~ → **삭제됨**
- 현재 `simulator.html`이 **CDC 동기화 시뮬레이터**로 사용 중
- ~~BOOK 테이블만 테스트 가능~~ → 모든 테이블 동적 지원

### 1.2 목표
- 화면 목적 재정의: 모니터링 → **동기화 시뮬레이터**
- 모든 테이블 (BOOK, MEMBER, LEGACY_CODE, NEW_SERVICE) 테스트 지원
- 동기화 전체 흐름 (원본→CDC→STAGING→대상) 확인 가능
- 테이블 추가 시 코드 수정 없이 설정만으로 확장

### 1.3 기술 스택 변경
- **Before**: static HTML + JavaScript (fetch API)
- **After**: Spring Boot + Thymeleaf + JavaScript

---

## 2. 현재 문제점

### 2.1 화면 목적 불일치 ✅ 해결됨
| 이전 | 현재 (해결됨) |
|------|----------|
| CDC 모니터링 대시보드 | **CDC 동기화 시뮬레이터** |

### 2.2 테이블 확장성 부재 ✅ 해결됨
```java
// 이전: TestController.java - 하드코딩 (삭제됨)
// 현재: SimulatorController.java - 동적 테이블 지원
```
- ~~BOOK 테이블만 테스트 가능~~ → 모든 테이블 테스트 가능
- ~~테이블 추가 시 Java 코드 수정 필요~~ → YAML 설정만 추가

### 2.3 동기화 흐름 확인 불가
```
원본 → CDC → STAGING → 대상
        ↑       ✗        ✗
     현재까지만 표시
```

### 2.4 동기화 방향별 구분 미흡
| 방향 | 테이블 | 현재 UI 지원 |
|------|--------|:------------:|
| 구→신 (ASIS→TOBE) | LEGACY_CODE | ✗ |
| 신→구 (TOBE→ASIS) | NEW_SERVICE | ✗ |
| 양방향 | BOOK, MEMBER | △ (BOOK만) |

---

## 3. 개선 설계

### 3.1 화면 제목 변경
```
Before: CDC 모니터링 대시보드
After:  CDC 동기화 시뮬레이터
        "동기화 흐름 테스트 및 검증 도구"
```

### 3.2 탭 기반 UI 구조

```
┌─────────────────────────────────────────────────────────────────┐
│  CDC 동기화 시뮬레이터                           [자동새로고침]  │
├─────────────────────────────────────────────────────────────────┤
│  [테스트 실행]  [동기화 흐름]  [이력/통계]                       │
├─────────────────────────────────────────────────────────────────┤
│                        (탭 내용)                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### Tab 1: 테스트 실행
- 테이블 선택 드롭다운 (BOOK/MEMBER/LEGACY_CODE/NEW_SERVICE)
- 동기화 방향 자동 표시
- 방향에 따른 테스트 버튼 활성/비활성
- 동적 입력 폼 (테이블 컬럼에 맞게)

#### Tab 2: 동기화 흐름
- 4단계 흐름도: 원본 → CDC → STAGING → 대상
- 각 단계별 데이터 및 상태 표시
- 스키마 변환 전/후 비교

#### Tab 3: 이력/통계
- 통계 카드 (성공/실패/무한루프차단)
- CDC_SYNC_LOG 테이블 조회
- 에러 상세 내용

### 3.3 테이블 설정 (YAML)

```yaml
# application.yml
cdc:
  tables:
    - name: BOOK
      displayName: 도서
      direction: BIDIRECTIONAL
      asis:
        schema: ASIS_USER
        table: BOOK_INFO
        pk: BOOK_ID
        columns: [BOOK_ID, BOOK_TITLE, AUTHOR, CATEGORY, STATUS]
      tobe:
        schema: TOBE_USER
        table: TB_BOOK
        pk: BOOK_ID
        columns: [BOOK_ID, TITLE, AUTHOR_NAME, CATEGORY_CD, IS_ACTIVE]
      cdcTable:
        asis: CDC_ASIS_BOOK
        tobe: CDC_TOBE_BOOK
      stagingTable:
        asis: STAGING_ASIS_BOOK
        tobe: STAGING_TOBE_BOOK

    - name: MEMBER
      displayName: 회원
      direction: BIDIRECTIONAL
      # ... 동일 구조

    - name: LEGACY_CODE
      displayName: 레거시코드
      direction: ASIS_TO_TOBE

    - name: NEW_SERVICE
      displayName: 신규서비스
      direction: TOBE_TO_ASIS
```

### 3.4 API 구조

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | /api/tables | 테이블 목록 + 설정 |
| GET | /api/tables/{name}/config | 테이블 설정 상세 |
| POST | /api/test/{table}/asis/{op} | ASIS에서 CUD 실행 |
| POST | /api/test/{table}/tobe/{op} | TOBE에서 CUD 실행 |
| GET | /api/flow/{table}/{pk} | 동기화 흐름 상태 |
| GET | /api/staging/{table} | STAGING 테이블 조회 |
| GET | /api/sync-log | CDC_SYNC_LOG 조회 |
| GET | /api/stats | 통계 데이터 |

---

## 4. 구현 계획 (완료)

### Phase 1: 기반 구축 ✅
- [x] pom.xml에 Thymeleaf 의존성 추가
- [x] application.yml에 테이블 설정 구조 정의
- [x] CdcSimulatorConfig 클래스 생성 (설정 바인딩)
- [x] DashboardController를 Thymeleaf용으로 변경

### Phase 2: 동적 테스트 API ✅
- [x] SimulatorController 생성 (동적 테이블 지원)
- [x] 동적 SQL 생성 (SimulatorController 내부)
- [x] STAGING 테이블 조회 API 추가
- [x] CDC_SYNC_LOG 조회 API 추가
- [x] 통계 조회 API 추가

### Phase 3: UI 구현 ✅
- [x] 기본 레이아웃 (탭 구조)
- [x] Tab1: 테스트 실행 화면
- [x] Tab2: 동기화 흐름 화면
- [x] Tab3: 이력/통계 화면

### Phase 4: 마무리 ✅
- [x] JavaScript API 연동 완료
- [x] 에러 핸들링 구현
- [x] 문서 업데이트

---

## 5. 파일 구조 (최종)

```
sync-service-java/
├── src/main/java/com/cdc/sync/
│   ├── config/
│   │   ├── CdcSimulatorConfig.java   # 테이블 설정 바인딩
│   │   ├── DataSourceConfig.java     # 다중 DataSource 설정
│   │   └── KafkaConfig.java          # Kafka Consumer 설정
│   ├── controller/                   # ← monitoring/ 에서 이동 (2026-01-14)
│   │   ├── DashboardController.java  # Thymeleaf 뷰 컨트롤러
│   │   ├── SimulatorController.java  # 동적 테이블 API
│   │   └── MonitoringController.java # 인메모리 통계 API
│   ├── consumer/
│   │   └── CdcKafkaConsumer.java     # Kafka 메시지 수신
│   ├── domain/                       # ← model/ 에서 이동
│   │   └── CdcEvent.java             # CDC 이벤트 도메인
│   └── service/
│       ├── CdcSyncService.java       # 핵심 동기화 로직
│       └── CdcMonitoringService.java # 인메모리 통계
├── src/main/resources/
│   ├── application.yml               # 테이블 설정 포함
│   └── templates/
│       └── simulator.html            # Thymeleaf 템플릿 (3개 탭)
└── pom.xml                           # Thymeleaf 의존성 포함
```

> **변경사항 (2026-01-14)**:
> - `monitoring/` → `controller/` 이동 (역할 명확화)
> - `model/` → `domain/` 이동 (DDD 용어)
> - `TestController.java` 삭제 (SimulatorController로 대체)
> - `static/dashboard.html` 삭제 (templates/simulator.html로 대체)

---

## 6. 설계 결정 사항

| 항목 | 결정 | 이유 |
|------|------|------|
| 테이블 설정 관리 | YAML 파일 | PoC 단계에서 간단하고 빠름 |
| UI 구조 | 탭 기반 | 기능별 분리로 가독성 향상 |
| STAGING/SYNC_LOG API | 신규 생성 | 동기화 흐름 확인에 필수 |

### 향후 개선 사항 (TODO)

> **DB 방식 전환**: 여유 있을 때 YAML → DB 테이블 방식으로 전환 검토
> - 현재: application.yml에 테이블 설정 정의
> - 향후: SYNC_TABLE_MAPPING, SYNC_COLUMN_MAPPING 등 DB 테이블 활용
> - 이유: 실무에서는 171개 테이블 관리 시 DB 방식이 적합
> - 단, 시뮬레이션은 10개 미만 테이블로 충분하므로 YAML도 무방

---

## 7. 참고 자료

- [Effective Dashboard Design Principles for 2025](https://www.uxpin.com/studio/blog/dashboard-design-principles/)
- [Spring Boot and Thymeleaf](https://igventurelli.io/spring-boot-and-thymeleaf-building-dynamic-web-applications/)
- 관련 문서: `14_개발_진행_기록.md` 섹션 2.4, 6.2, 9.2

---

## 8. 변경 이력

| 날짜 | 내용 |
|------|------|
| 2026-01-14 | 초안 작성, 설계 계획 수립 |
| 2026-01-14 | **구현 완료** - Phase 1~4 전체 완료 |
| 2026-01-14 | **리팩토링** - 패키지 구조 개선, 죽은 코드 삭제 (문서 현행화) |

---

## 9. 구현 결과 요약

### 최종 파일 목록 (11개)
| 패키지 | 파일 | 역할 |
|--------|------|------|
| config | CdcSimulatorConfig.java | 동적 테이블 설정 |
| config | DataSourceConfig.java | 다중 DataSource 설정 |
| config | KafkaConfig.java | Kafka Consumer 설정 |
| consumer | CdcKafkaConsumer.java | Kafka 메시지 수신 |
| controller | DashboardController.java | Thymeleaf 뷰 |
| controller | MonitoringController.java | 모니터링 REST API |
| controller | SimulatorController.java | 시뮬레이터 REST API |
| domain | CdcEvent.java | CDC 이벤트 도메인 |
| service | CdcMonitoringService.java | 인메모리 통계 |
| service | CdcSyncService.java | 핵심 동기화 로직 |
| - | SyncServiceApplication.java | Spring Boot 메인 |

### 삭제된 파일
| 파일 | 삭제 이유 |
|------|----------|
| `monitoring/TestController.java` | SimulatorController로 대체 |
| `static/dashboard.html` | templates/simulator.html로 대체 |

### 새 API 엔드포인트
```
/api/simulator/{tableName}/{db}/data     - 원본 테이블 조회
/api/simulator/{tableName}/{db}/cdc      - CDC 테이블 조회
/api/simulator/{tableName}/{db}/staging  - STAGING 테이블 조회
/api/simulator/sync-log                  - 동기화 로그 조회
/api/simulator/stats                     - 통계 조회
/api/simulator/{tableName}/{db}/insert   - INSERT 테스트
/api/simulator/{tableName}/{db}/update   - UPDATE 테스트
/api/simulator/{tableName}/{db}/delete   - DELETE 테스트
```

### 접속 URL
- **시뮬레이터**: http://localhost:8082/simulator
- **테이블 지정**: http://localhost:8082/simulator?table=MEMBER

---

## 10. 시뮬레이터 개선 로드맵 (v2)

> **작성일**: 2026-01-14
> **목적**: 시뮬레이터의 본래 목적 달성을 위한 개선 계획

### 10.1 시뮬레이터의 목적

| 목적 | 설명 | 현재 달성도 |
|------|------|:----------:|
| **1. 동기화 흐름 시각화** | 원본→CDC→STAGING→대상 4단계 흐름이 어떻게 동작하는지 확인 | 75% |
| **2. 충돌 케이스 테스트** | 모든 충돌/에러 케이스에서 성공/실패 메시지가 어떻게 나오는지 확인 | 17% |

### 10.2 현재 미흡한 점

#### 목적 1 관련 (동기화 흐름)
- 각 단계별 "조회" 버튼을 개별 클릭해야 함 (번거로움)
- 스키마 변환 과정이 표시되지 않음 (ASIS 컬럼 → TOBE 컬럼)
- 처리 시간/지연 정보가 없음

#### 목적 2 관련 (충돌 케이스)
- 양방향 동시 실행 테스트 불가 (한쪽씩만 실행 가능)
- 정의된 에러코드 케이스 대부분 테스트 불가
- 충돌 정책(LWW, ASIS_PRIORITY 등) 검증 불가

### 10.3 개선 항목 (TODO)

#### Phase 5: UX 개선 (우선순위: 높음)

| ID | 항목 | 설명 | 상태 |
|:--:|------|------|:----:|
| 5.1 | **전체 새로고침 버튼** | 동기화 흐름 탭에서 4단계 한번에 조회 | TODO |
| 5.2 | **자동 새로고침** | 3초/5초/10초 간격 자동 갱신 토글 | TODO |
| 5.3 | **단계별 상태 아이콘** | ✓완료, ⏳대기, ❌에러 시각화 | TODO |
| 5.4 | **처리 시간 표시** | 각 단계별 소요 시간 (ms/s) | TODO |

#### Phase 6: 충돌 시나리오 테스트 (우선순위: 높음)

| ID | 항목 | 설명 | 상태 |
|:--:|------|------|:----:|
| 6.1 | **시나리오 선택 UI** | 사전 정의된 테스트 시나리오 목록 | TODO |
| 6.2 | **동시 실행 기능** | ASIS/TOBE 양쪽 동시 CUD 실행 | TODO |
| 6.3 | **충돌 정책 테스트** | LWW, ASIS_PRIORITY 등 정책별 결과 확인 | TODO |
| 6.4 | **에러코드별 테스트** | SYNC_E_*, CONF_E_*, MAP_E_* 케이스 | TODO |

#### Phase 7: 스키마 변환 시각화 (우선순위: 중간)

| ID | 항목 | 설명 | 상태 |
|:--:|------|------|:----:|
| 7.1 | **컬럼 매핑 표시** | BOOK_TITLE → TITLE 변환 과정 | TODO |
| 7.2 | **코드 변환 표시** | 'Y'/'N' → 1/0 변환 과정 | TODO |
| 7.3 | **기본값 적용 표시** | NULL → 'SYSTEM' 기본값 적용 | TODO |

#### Phase 8: 모니터링 확장 (우선순위: 중간)

| ID | 항목 | 설명 | 상태 |
|:--:|------|------|:----:|
| 8.1 | **에러 유형별 통계** | SYNC/CONF/MAP/DATA 카테고리별 | TODO |
| 8.2 | **충돌 정책별 통계** | LWW/ASIS_PRIORITY/MANUAL 적용 현황 | TODO |
| 8.3 | **에러 상세 모달** | 에러코드별 상세 정보 및 처리 옵션 | TODO |

### 10.4 참고: 에러코드 체계 (임시)

> **주의**: 아래 에러코드는 PoC용 임시 정의입니다. 실제 프로젝트에서는 업무 분석 후 확정 필요.

| 카테고리 | 코드 예시 | 용도 | 상태 |
|----------|----------|------|:----:|
| SYNC | SYNC_E_001~008 | 동기화 처리 에러 | 임시 |
| CONF | CONF_E_001~004 | 충돌 관련 에러 | 임시 |
| MAP | MAP_E_001~006 | 스키마 매핑 에러 | 임시 |
| DATA | DATA_E_001~005 | 데이터 검증 에러 | 임시 |

> 상세 내용: `02-설계/05_에러코드_체계.md` 참조 (임시 문서)

### 10.5 구현 시 학습 포인트

시뮬레이터 개선 구현 시 아래 내용을 학습/참고할 수 있도록 상세 주석과 문서화 병행:

1. **Spring Boot + Thymeleaf 동적 UI**
   - 서버 사이드 렌더링 vs 클라이언트 사이드
   - Fragment를 활용한 부분 갱신

2. **JavaScript 비동기 처리**
   - Promise.all로 병렬 API 호출
   - async/await 패턴

3. **양방향 동기화 충돌 처리**
   - 동시성 문제 시뮬레이션
   - 타임스탬프 기반 LWW 구현

4. **에러 핸들링 패턴**
   - 에러코드 체계 설계
   - 사용자 친화적 에러 메시지

---

## 11. 트러블슈팅 기록

> **목적**: PoC 진행 중 발생한 문제와 해결 과정을 기록하여 학습 및 참고 자료로 활용

### 11.1 DELETE 동기화 미작동 문제 (2026-01-14)

#### 증상
- TOBE에서 DELETE 실행 시 "성공"으로 표시
- 그러나 동기화 흐름에서 STAGING 테이블이 비어있음
- ASIS 원본에 반영되지 않음

#### 원인 분석 과정

```
1. CDC_ASIS_BOOK 확인 → 데이터 있음 (PROCESSED_YN = 'N')
   └─ CDC 테이블까지는 정상 도착

2. STAGING_ASIS_BOOK 확인 → 데이터 없음
   └─ CDC → STAGING 변환이 안 됨

3. ASIS Scheduler Job 확인 → 없음!
   └─ TOBE에는 JOB_CDC_WORKER가 있는데 ASIS에는 없음

4. ASIS 프로시저 확인 → 전부 없음!
   └─ 04_create_procedures.sql이 실행되지 않음
```

#### 근본 원인
ASIS Oracle 초기화 시 `04_create_procedures.sql` 스크립트가 실행되지 않음

#### 해결 과정

1. **함수 생성**
   ```sql
   -- ASIS Oracle에 수동 생성
   CREATE OR REPLACE FUNCTION FN_CONVERT_CODE(...);
   CREATE OR REPLACE FUNCTION FN_GENERATE_HASH(...);
   CREATE OR REPLACE FUNCTION FN_IS_LOOP(...);
   ```

2. **프로시저 생성**
   ```sql
   CREATE OR REPLACE PROCEDURE SP_RECORD_HASH(...);
   CREATE OR REPLACE PROCEDURE SP_CLEANUP_HASH;
   CREATE OR REPLACE PROCEDURE SP_WORKER_BOOK;
   CREATE OR REPLACE PROCEDURE SP_WORKER_MEMBER;
   CREATE OR REPLACE PROCEDURE SP_WORKER_NEW_SERVICE;
   CREATE OR REPLACE PROCEDURE SP_RUN_ALL_WORKERS;
   ```

3. **매핑 데이터 추가** (누락되어 있었음)
   ```sql
   INSERT INTO SYNC_CODE_MAPPING VALUES ('CATEGORY_MAP', 'TOBE', 'LIT', 'ASIS', '01', '문학');
   INSERT INTO SYNC_CODE_MAPPING VALUES ('CATEGORY_MAP', 'TOBE', 'SCI', 'ASIS', '02', '과학');
   -- ... 기타 매핑
   ```

4. **에러 데이터 재처리**
   ```sql
   UPDATE CDC_ASIS_BOOK SET PROCESSED_YN = 'N' WHERE PROCESSED_YN = 'E';
   ```

#### 결과
- DELETE 동기화 정상 작동 확인
- CDC_SYNC_LOG에 DELETE SUCCESS 기록됨

#### 교훈
- Docker 컨테이너 초기화 스크립트 실행 여부를 항상 확인
- 양쪽 DB(ASIS/TOBE) 오브젝트 일관성 검증 필요

---

## 12. 설계 vs 구현 차이점

### 12.1 동기화 흐름 순서

#### 원래 설계 (CDC 초기 설계.png)
```
원본 테이블 → CDC Agent → CDC_TABLES → STAGING → WORKER → 원본 테이블
                                        ↑
                                   스키마 변환
```
- CDC_TABLES에서 STAGING으로 **별도 프로세스**가 스키마 변환
- WORKER는 STAGING에서 원본으로 반영만 담당

#### 현재 구현
```
원본 테이블 → Debezium → CDC_TABLES → WORKER(1단계) → STAGING → WORKER(2단계) → 원본 테이블
                                        ↑                        ↑
                                   스키마 변환              원본 반영
```
- WORKER가 **두 역할** 모두 수행 (스키마 변환 + 원본 반영)

#### 차이 발생 이유
1. **PoC 단순화**: 별도 변환 프로세스 대신 WORKER에 통합
2. **트랜잭션 관리**: 한 프로시저 내에서 CDC→STAGING→원본 일관성 유지
3. **장단점**:
   - 장점: 구현 단순, 관리 포인트 감소
   - 단점: WORKER 역할이 비대해짐, 설계도와 불일치

#### 권장 개선 방향 (실제 프로젝트용)
```sql
-- 역할 분리
SP_TRANSFORM_BOOK   -- CDC → STAGING (스키마 변환만)
SP_APPLY_BOOK       -- STAGING → 원본 (반영만)
SP_RUN_ALL_WORKERS  -- 위 두 개를 순차 호출
```

### 12.2 UPDATE 시 전체 행 전송 이슈

#### 현재 동작
```
TOBE에서: UPDATE TB_BOOK SET TITLE = '새제목' WHERE BOOK_ID = 1;

→ CDC 테이블에 INSERT되는 데이터:
  BOOK_ID=1, TITLE='새제목', AUTHOR_NAME='작가', CATEGORY_CD='LIT', IS_ACTIVE=1
  (수정하지 않은 컬럼도 모두 포함)

→ ASIS에 적용:
  UPDATE BOOK_INFO SET BOOK_TITLE='새제목', AUTHOR='작가', CATEGORY='01', STATUS='Y'
  WHERE BOOK_ID = 1;
  (전체 컬럼 덮어쓰기)
```

#### 문제점
- 불필요한 컬럼까지 UPDATE하여 트리거 발동 가능
- 동시 수정 시 한쪽 변경 유실 가능성
  ```
  시간순서:
  1. ASIS에서 AUTHOR 수정
  2. TOBE에서 TITLE 수정 (전체 행 가져옴, 이전 AUTHOR 포함)
  3. TOBE CDC가 ASIS에 적용 → AUTHOR가 예전 값으로 덮어씀
  ```

#### 부분 UPDATE 구현 방법

**방법 1: before 이미지 비교**
```json
// Debezium 설정
"before.image": "full"

// Kafka 메시지에 포함:
{
  "before": {"TITLE": "옛날제목", "AUTHOR": "작가"},
  "after": {"TITLE": "새제목", "AUTHOR": "작가"}
}
```
```sql
-- WORKER에서 비교 후 변경된 컬럼만 UPDATE
IF rec.BEFORE_TITLE != rec.AFTER_TITLE THEN
    UPDATE ... SET TITLE = rec.AFTER_TITLE;
END IF;
```

**방법 2: CDC 테이블에 변경 컬럼 플래그 추가**
```sql
CDC_ASIS_BOOK (
    ...
    CHANGED_COLUMNS VARCHAR2(500),  -- 'TITLE,AUTHOR' 형태
    ...
)
```

#### 현재 PoC 결정
- **전체 행 UPDATE 유지** (복잡도 증가 방지)
- 실제 프로젝트에서는 부분 UPDATE 구현 권장

### 12.3 대상에 없는 데이터 DELETE

#### 시나리오
- TOBE에만 존재하는 BOOK_ID=100
- TOBE에서 DELETE 실행
- ASIS에는 원래 없었음

#### 현재 동작
```sql
DELETE FROM BOOK_INFO WHERE BOOK_ID = 100;
-- 결과: 0 rows deleted (에러 아님)
-- CDC_SYNC_LOG: SUCCESS
```

#### 개선 방향
```sql
-- SQL%ROWCOUNT 확인하여 WARNING 상태 기록
IF SQL%ROWCOUNT = 0 THEN
    -- 'TARGET_NOT_FOUND' 상태로 기록
END IF;
```

> **TODO**: WORKER 프로시저에 TARGET_NOT_FOUND 처리 로직 추가

