# 대시보드 개선 계획

> **목표**: CDC 동기화 시뮬레이터 대시보드 구현 계획을 설명합니다.
>
> **상태**: 완료

---

## 1. 개요

### 1.1 배경
- ~~이전 `dashboard.html`은 "CDC 모니터링 대시보드"로 명명~~ → **삭제됨**
- 현재 `simulator.html`이 **CDC 동기화 시뮬레이터**로 사용 중
- ~~BOOK 테이블만 테스트 가능~~ → 모든 테이블 동적 지원

### 1.2 목표
- 화면 목적 재정의: 모니터링 → **동기화 시뮬레이터**
- 모든 테이블 (BOOK, MEMBER, LEGACY_CODE, NEW_SERVICE) 테스트 지원
- 동기화 전체 흐름 (원본→CDC→STAGING→대상) 확인 가능
- 테이블 추가 시 코드 수정 없이 설정만으로 확장

### 1.3 기술 스택 변경
- **Before**: static HTML + JavaScript (fetch API)
- **After**: Spring Boot + Thymeleaf + JavaScript

---

## 2. 현재 문제점

### 2.1 화면 목적 불일치 ✅ 해결됨
| 이전 | 현재 (해결됨) |
|------|----------|
| CDC 모니터링 대시보드 | **CDC 동기화 시뮬레이터** |

### 2.2 테이블 확장성 부재 ✅ 해결됨
```java
// 이전: TestController.java - 하드코딩 (삭제됨)
// 현재: SimulatorController.java - 동적 테이블 지원
```
- ~~BOOK 테이블만 테스트 가능~~ → 모든 테이블 테스트 가능
- ~~테이블 추가 시 Java 코드 수정 필요~~ → YAML 설정만 추가

### 2.3 동기화 흐름 확인 불가
```
원본 → CDC → STAGING → 대상
        ↑       ✗        ✗
     현재까지만 표시
```

### 2.4 동기화 방향별 구분 미흡
| 방향 | 테이블 | 현재 UI 지원 |
|------|--------|:------------:|
| 구→신 (ASIS→TOBE) | LEGACY_CODE | ✗ |
| 신→구 (TOBE→ASIS) | NEW_SERVICE | ✗ |
| 양방향 | BOOK, MEMBER | △ (BOOK만) |

---

## 3. 개선 설계

### 3.1 화면 제목 변경
```
Before: CDC 모니터링 대시보드
After:  CDC 동기화 시뮬레이터
        "동기화 흐름 테스트 및 검증 도구"
```

### 3.2 탭 기반 UI 구조

```
┌─────────────────────────────────────────────────────────────────┐
│  CDC 동기화 시뮬레이터                           [자동새로고침]  │
├─────────────────────────────────────────────────────────────────┤
│  [테스트 실행]  [동기화 흐름]  [이력/통계]                       │
├─────────────────────────────────────────────────────────────────┤
│                        (탭 내용)                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### Tab 1: 테스트 실행
- 테이블 선택 드롭다운 (BOOK/MEMBER/LEGACY_CODE/NEW_SERVICE)
- 동기화 방향 자동 표시
- 방향에 따른 테스트 버튼 활성/비활성
- 동적 입력 폼 (테이블 컬럼에 맞게)

#### Tab 2: 동기화 흐름
- 4단계 흐름도: 원본 → CDC → STAGING → 대상
- 각 단계별 데이터 및 상태 표시
- 스키마 변환 전/후 비교

#### Tab 3: 이력/통계
- 통계 카드 (성공/실패/무한루프차단)
- CDC_SYNC_LOG 테이블 조회
- 에러 상세 내용

### 3.3 테이블 설정 (YAML)

```yaml
# application.yml
cdc:
  tables:
    - name: BOOK
      displayName: 도서
      direction: BIDIRECTIONAL
      asis:
        schema: ASIS_USER
        table: BOOK_INFO
        pk: BOOK_ID
        columns: [BOOK_ID, BOOK_TITLE, AUTHOR, CATEGORY, STATUS]
      tobe:
        schema: TOBE_USER
        table: TB_BOOK
        pk: BOOK_ID
        columns: [BOOK_ID, TITLE, AUTHOR_NAME, CATEGORY_CD, IS_ACTIVE]
      cdcTable:
        asis: CDC_ASIS_BOOK
        tobe: CDC_TOBE_BOOK
      stagingTable:
        asis: STAGING_ASIS_BOOK
        tobe: STAGING_TOBE_BOOK

    - name: MEMBER
      displayName: 회원
      direction: BIDIRECTIONAL
      # ... 동일 구조

    - name: LEGACY_CODE
      displayName: 레거시코드
      direction: ASIS_TO_TOBE

    - name: NEW_SERVICE
      displayName: 신규서비스
      direction: TOBE_TO_ASIS
```

### 3.4 API 구조

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | /api/tables | 테이블 목록 + 설정 |
| GET | /api/tables/{name}/config | 테이블 설정 상세 |
| POST | /api/test/{table}/asis/{op} | ASIS에서 CUD 실행 |
| POST | /api/test/{table}/tobe/{op} | TOBE에서 CUD 실행 |
| GET | /api/flow/{table}/{pk} | 동기화 흐름 상태 |
| GET | /api/staging/{table} | STAGING 테이블 조회 |
| GET | /api/sync-log | CDC_SYNC_LOG 조회 |
| GET | /api/stats | 통계 데이터 |

---

## 4. 구현 계획 (완료)

### Phase 1: 기반 구축 ✅
- [x] pom.xml에 Thymeleaf 의존성 추가
- [x] application.yml에 테이블 설정 구조 정의
- [x] CdcSimulatorConfig 클래스 생성 (설정 바인딩)
- [x] DashboardController를 Thymeleaf용으로 변경

### Phase 2: 동적 테스트 API ✅
- [x] SimulatorController 생성 (동적 테이블 지원)
- [x] 동적 SQL 생성 (SimulatorController 내부)
- [x] STAGING 테이블 조회 API 추가
- [x] CDC_SYNC_LOG 조회 API 추가
- [x] 통계 조회 API 추가

### Phase 3: UI 구현 ✅
- [x] 기본 레이아웃 (탭 구조)
- [x] Tab1: 테스트 실행 화면
- [x] Tab2: 동기화 흐름 화면
- [x] Tab3: 이력/통계 화면

### Phase 4: 마무리 ✅
- [x] JavaScript API 연동 완료
- [x] 에러 핸들링 구현
- [x] 문서 업데이트

---

## 5. 파일 구조 (최종)

```
sync-service-java/
├── src/main/java/com/cdc/sync/
│   ├── config/
│   │   ├── CdcSimulatorConfig.java   # 테이블 설정 바인딩
│   │   ├── DataSourceConfig.java     # 다중 DataSource 설정
│   │   └── KafkaConfig.java          # Kafka Consumer 설정
│   ├── controller/                   # ← monitoring/ 에서 이동 (2026-01-14)
│   │   ├── DashboardController.java  # Thymeleaf 뷰 컨트롤러
│   │   ├── SimulatorController.java  # 동적 테이블 API
│   │   └── MonitoringController.java # 인메모리 통계 API
│   ├── consumer/
│   │   └── CdcKafkaConsumer.java     # Kafka 메시지 수신
│   ├── domain/                       # ← model/ 에서 이동
│   │   └── CdcEvent.java             # CDC 이벤트 도메인
│   └── service/
│       ├── CdcSyncService.java       # 핵심 동기화 로직
│       └── CdcMonitoringService.java # 인메모리 통계
├── src/main/resources/
│   ├── application.yml               # 테이블 설정 포함
│   └── templates/
│       └── simulator.html            # Thymeleaf 템플릿 (3개 탭)
└── pom.xml                           # Thymeleaf 의존성 포함
```

> **변경사항 (2026-01-14)**:
> - `monitoring/` → `controller/` 이동 (역할 명확화)
> - `model/` → `domain/` 이동 (DDD 용어)
> - `TestController.java` 삭제 (SimulatorController로 대체)
> - `static/dashboard.html` 삭제 (templates/simulator.html로 대체)

---

## 6. 설계 결정 사항

| 항목 | 결정 | 이유 |
|------|------|------|
| 테이블 설정 관리 | YAML 파일 | PoC 단계에서 간단하고 빠름 |
| UI 구조 | 탭 기반 | 기능별 분리로 가독성 향상 |
| STAGING/SYNC_LOG API | 신규 생성 | 동기화 흐름 확인에 필수 |

### 향후 개선 사항 (TODO)

> **DB 방식 전환**: 여유 있을 때 YAML → DB 테이블 방식으로 전환 검토
> - 현재: application.yml에 테이블 설정 정의
> - 향후: SYNC_TABLE_MAPPING, SYNC_COLUMN_MAPPING 등 DB 테이블 활용
> - 이유: 실무에서는 171개 테이블 관리 시 DB 방식이 적합
> - 단, 시뮬레이션은 10개 미만 테이블로 충분하므로 YAML도 무방

---

## 7. 참고 자료

- [Effective Dashboard Design Principles for 2025](https://www.uxpin.com/studio/blog/dashboard-design-principles/)
- [Spring Boot and Thymeleaf](https://igventurelli.io/spring-boot-and-thymeleaf-building-dynamic-web-applications/)
- 관련 문서: `14_개발_진행_기록.md` 섹션 2.4, 6.2, 9.2

---

## 8. 변경 이력

| 날짜 | 내용 |
|------|------|
| 2026-01-14 | 초안 작성, 설계 계획 수립 |
| 2026-01-14 | **구현 완료** - Phase 1~4 전체 완료 |
| 2026-01-14 | **리팩토링** - 패키지 구조 개선, 죽은 코드 삭제 (문서 현행화) |

---

## 9. 구현 결과 요약

### 최종 파일 목록 (11개)
| 패키지 | 파일 | 역할 |
|--------|------|------|
| config | CdcSimulatorConfig.java | 동적 테이블 설정 |
| config | DataSourceConfig.java | 다중 DataSource 설정 |
| config | KafkaConfig.java | Kafka Consumer 설정 |
| consumer | CdcKafkaConsumer.java | Kafka 메시지 수신 |
| controller | DashboardController.java | Thymeleaf 뷰 |
| controller | MonitoringController.java | 모니터링 REST API |
| controller | SimulatorController.java | 시뮬레이터 REST API |
| domain | CdcEvent.java | CDC 이벤트 도메인 |
| service | CdcMonitoringService.java | 인메모리 통계 |
| service | CdcSyncService.java | 핵심 동기화 로직 |
| - | SyncServiceApplication.java | Spring Boot 메인 |

### 삭제된 파일
| 파일 | 삭제 이유 |
|------|----------|
| `monitoring/TestController.java` | SimulatorController로 대체 |
| `static/dashboard.html` | templates/simulator.html로 대체 |

### 새 API 엔드포인트
```
/api/simulator/{tableName}/{db}/data     - 원본 테이블 조회
/api/simulator/{tableName}/{db}/cdc      - CDC 테이블 조회
/api/simulator/{tableName}/{db}/staging  - STAGING 테이블 조회
/api/simulator/sync-log                  - 동기화 로그 조회
/api/simulator/stats                     - 통계 조회
/api/simulator/{tableName}/{db}/insert   - INSERT 테스트
/api/simulator/{tableName}/{db}/update   - UPDATE 테스트
/api/simulator/{tableName}/{db}/delete   - DELETE 테스트
```

### 접속 URL
- **시뮬레이터**: http://localhost:8082/simulator
- **테이블 지정**: http://localhost:8082/simulator?table=MEMBER

