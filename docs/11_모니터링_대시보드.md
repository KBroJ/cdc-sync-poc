# CDC 모니터링 대시보드 가이드

> 이 문서는 CDC 모니터링 대시보드 사용법을 설명합니다.

---

## 1. 대시보드 접속

### 1.1 웹 대시보드

브라우저에서 접속: **http://localhost:8082/dashboard**

### 1.2 화면 구성

```
┌─────────────────────────────────────────────────────────────┐
│                  CDC 모니터링 대시보드                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │ 총 수신  │  │  성공   │  │  실패   │  │ 성공률  │        │
│  │   10    │  │    8    │  │    2    │  │  80%   │        │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │
├─────────────────────────────────────────────────────────────┤
│  📋 최근 이벤트                                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 시간    │ 상태  │ 토픽      │ 테이블      │ 작업     │  │
│  │ 06:23   │ ✓     │ BOOK_INFO │ CDC_TOBE_.. │ UPDATE  │  │
│  │ 06:22   │ ✗     │ MEMBER_.. │ CDC_TOBE_.. │ INSERT  │  │
│  └───────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  ⚠️ 최근 에러                                                │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ 시간    │ 토픽      │ 테이블      │ 에러 메시지       │  │
│  │ 06:22   │ MEMBER_.. │ CDC_TOBE_.. │ ORA-00932...     │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 주요 기능

| 기능 | 설명 |
|------|------|
| 자동 새로고침 | 5초마다 자동 업데이트 (토글 가능) |
| 성공/실패 표시 | 색상으로 구분 (녹색=성공, 빨간색=실패) |
| 작업 유형 표시 | INSERT/UPDATE/DELETE 배지 |
| 에러 메시지 | 마우스 오버 시 전체 메시지 확인 |

---

## 2. REST API 엔드포인트

### 2.1 전체 통계 조회

```bash
curl http://localhost:8082/api/monitoring/stats
```

**응답:**
```json
{
  "totalReceived": 10,
  "totalSuccess": 8,
  "totalFailed": 2,
  "successRate": 80.0,
  "tableStats": {
    "asis.ASIS_USER.BOOK_INFO": {
      "received": 5,
      "success": 5,
      "failed": 0,
      "lastSuccess": "2026-01-13T06:23:54",
      "lastError": null
    }
  }
}
```

**필드 설명:**

| 필드 | 설명 |
|------|------|
| totalReceived | 총 수신 이벤트 수 |
| totalSuccess | 성공 처리 수 |
| totalFailed | 실패 처리 수 |
| successRate | 성공률 (%) |
| tableStats | 토픽별 상세 통계 |

### 2.2 최근 이벤트 조회

```bash
curl http://localhost:8082/api/monitoring/events
```

**응답:**
```json
[
  {
    "timestamp": "2026-01-13 06:23:54",
    "status": "SUCCESS",
    "topic": "asis.ASIS_USER.BOOK_INFO",
    "targetTable": "CDC_TOBE_BOOK",
    "operation": "UPDATE",
    "hash": "9dc2ee7d1354e9b9",
    "errorMessage": null
  }
]
```

### 2.3 최근 에러 조회

```bash
curl http://localhost:8082/api/monitoring/errors
```

**응답:**
```json
[
  {
    "timestamp": "2026-01-13 06:22:10",
    "topic": "asis.ASIS_USER.MEMBER_INFO",
    "targetTable": "CDC_TOBE_MEMBER",
    "operation": "INSERT",
    "errorMessage": "ORA-00932: inconsistent datatypes..."
  }
]
```

### 2.4 통합 대시보드 데이터

```bash
curl http://localhost:8082/api/monitoring/dashboard
```

**응답:** stats + recentEvents + recentErrors 통합

### 2.5 통계 초기화

```bash
curl -X POST http://localhost:8082/api/monitoring/reset
```

**응답:**
```json
{
  "status": "success",
  "message": "Statistics have been reset"
}
```

---

## 3. 모니터링 해석 방법

### 3.1 정상 상태

```
총 수신: 100  │  성공: 100  │  실패: 0  │  성공률: 100%
```

- 성공률 100%
- 에러 목록 비어있음
- 모든 이벤트가 SUCCESS 상태

### 3.2 문제 상태

```
총 수신: 100  │  성공: 85  │  실패: 15  │  성공률: 85%
```

**확인 순서:**

1. **에러 메시지 확인**
   ```bash
   curl http://localhost:8082/api/monitoring/errors | python -m json.tool
   ```

2. **에러 유형별 대응**

   | 에러 메시지 | 원인 | 해결 |
   |------------|------|------|
   | ORA-00942 table not found | CDC 테이블 없음 | 초기화 SQL 실행 |
   | ORA-00932 datatypes | 타입 불일치 | 코드 수정 필요 |
   | Connection refused | DB 연결 불가 | Oracle 컨테이너 확인 |

3. **Sync Service 로그 확인**
   ```bash
   docker logs sync-service --tail 50 | grep ERROR
   ```

### 3.3 토픽별 상태 분석

```json
"tableStats": {
  "asis.ASIS_USER.BOOK_INFO": {
    "received": 50,
    "success": 50,
    "failed": 0
  },
  "asis.ASIS_USER.MEMBER_INFO": {
    "received": 30,
    "success": 15,
    "failed": 15
  }
}
```

- BOOK_INFO: 정상 (100% 성공)
- MEMBER_INFO: 문제 있음 (50% 실패)
  → MEMBER_INFO 관련 에러 메시지 확인 필요

---

## 4. 모니터링 시나리오

### 4.1 성공 케이스 확인

**1단계: ASIS DB에서 UPDATE 실행**
```sql
UPDATE BOOK_INFO SET BOOK_TITLE = '테스트' WHERE BOOK_ID = 1;
COMMIT;
```

**2단계: 대시보드에서 확인**
- 총 수신: +1
- 성공: +1
- 최근 이벤트에 SUCCESS 행 추가

**3단계: API로 확인**
```bash
curl http://localhost:8082/api/monitoring/stats
# successRate가 유지되거나 증가
```

### 4.2 실패 케이스 확인

**1단계: CDC 테이블 삭제 (의도적 에러 유발)**
```sql
-- TOBE DB에서 실행
DROP TABLE CDC_TOBE_BOOK;
```

**2단계: ASIS DB에서 UPDATE 실행**
```sql
UPDATE BOOK_INFO SET BOOK_TITLE = '에러테스트' WHERE BOOK_ID = 1;
COMMIT;
```

**3단계: 대시보드에서 확인**
- 총 수신: +1
- 실패: +1
- 최근 에러에 새 행 추가
- 에러 메시지: "ORA-00942: table or view does not exist"

**4단계: 테이블 복구 후 정상화 확인**
```sql
-- CDC 테이블 재생성
-- (초기화 SQL 다시 실행)
```

### 4.3 실시간 모니터링

```bash
# 터미널에서 5초마다 통계 출력
while true; do
  clear
  echo "=== CDC 모니터링 $(date) ==="
  curl -s http://localhost:8082/api/monitoring/stats | python -m json.tool
  sleep 5
done
```

---

## 5. Kafka UI와 함께 사용하기

### 5.1 접속 정보

| 도구 | URL | 용도 |
|------|-----|------|
| CDC 대시보드 | http://localhost:8082/dashboard | 처리 결과 모니터링 |
| Kafka UI | http://localhost:8081 | 메시지/토픽 모니터링 |

### 5.2 함께 보면 좋은 항목

```
Kafka UI                          CDC 대시보드
┌──────────────────────┐          ┌──────────────────────┐
│ Topics               │          │ 최근 이벤트          │
│ - 메시지 수          │    →     │ - 처리 결과          │
│ - Consumer Lag       │          │ - 성공/실패 상태     │
├──────────────────────┤          ├──────────────────────┤
│ Connectors           │          │ 통계                 │
│ - 상태 (RUNNING)     │    →     │ - 성공률             │
└──────────────────────┘          └──────────────────────┘
```

**문제 진단 흐름:**

1. Kafka UI에서 메시지가 토픽에 있는지 확인
2. CDC 대시보드에서 처리 결과 확인
3. 실패 시 에러 메시지로 원인 파악

---

## 6. 접속 정보 요약

| 서비스 | URL |
|--------|-----|
| CDC 대시보드 | http://localhost:8082/dashboard |
| 모니터링 API | http://localhost:8082/api/monitoring/* |
| Health Check | http://localhost:8082/actuator/health |
| Kafka UI | http://localhost:8081 |

---

> **관련 문서:**
> - [12_소스레벨_상세_설명서.md](12_소스레벨_상세_설명서.md) - 소스 레벨 설명
> - [13_테스트_및_확인_방법.md](13_테스트_및_확인_방법.md) - 테스트 가이드
