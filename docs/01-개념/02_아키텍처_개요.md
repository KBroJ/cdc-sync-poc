# 아키텍처 개요

> **목표**: CDC PoC의 전체 구조와 데이터 흐름을 이해합니다.

---

## 1. 전체 시스템 구성

### 1.1 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Docker Compose 환경                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐                                      ┌──────────────┐    │
│  │ ASIS Oracle  │                                      │ TOBE Oracle  │    │
│  │   (15210)    │                                      │   (15220)    │    │
│  ├──────────────┤                                      ├──────────────┤    │
│  │ • BOOK_INFO  │                                      │ • TB_BOOK    │    │
│  │ • MEMBER_INFO│                                      │ • TB_MEMBER  │    │
│  │ • LEGACY_CODE│                                      │ • TB_NEW_SVC │    │
│  │              │                                      │              │    │
│  │ [CDC 테이블] │                                      │ [CDC 테이블] │    │
│  │ • CDC_ASIS_* │◀─┐                              ┌──▶│ • CDC_TOBE_* │    │
│  │ • STAGING_*  │  │                              │   │ • STAGING_*  │    │
│  │              │  │                              │   │              │    │
│  │ [WORKER]     │  │                              │   │ [WORKER]     │    │
│  │ 5초마다 실행  │  │                              │   │ 5초마다 실행  │    │
│  └──────┬───────┘  │                              │   └──────┬───────┘    │
│         │          │                              │          │            │
│         ▼          │                              │          ▼            │
│  ┌──────────────┐  │   ┌──────────────────┐      │   ┌──────────────┐    │
│  │  Debezium    │  │   │                  │      │   │  Debezium    │    │
│  │  Connector   │──┼──▶│      Kafka       │◀─────┼───│  Connector   │    │
│  │  (ASIS)      │  │   │                  │      │   │  (TOBE)      │    │
│  └──────────────┘  │   └────────┬─────────┘      │   └──────────────┘    │
│                    │            │                │                       │
│                    │            ▼                │                       │
│                    │   ┌──────────────────┐      │                       │
│                    │   │   Sync Service   │      │                       │
│                    │   │  (Java/Spring)   │      │                       │
│                    │   │                  │      │                       │
│                    │   │ Kafka Consumer   │      │                       │
│                    └───│ → CDC 테이블 저장 │──────┘                       │
│                        └──────────────────┘                              │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 1.2 컴포넌트 설명

| 컴포넌트 | 기술 스택 | 역할 | 포트 |
|---------|----------|------|------|
| **ASIS Oracle** | Oracle XE 21c | 기존 시스템 DB | 15210 |
| **TOBE Oracle** | Oracle XE 21c | 신규 시스템 DB | 15220 |
| **Debezium** | Debezium 2.4 | DB 변경 감지 (CDC) | - |
| **Kafka** | Confluent 7.5 | 메시지 브로커 | 9092 |
| **Zookeeper** | Confluent 7.5 | Kafka 클러스터 관리 | 2181 |
| **Kafka Connect** | Debezium Connect | Debezium 커넥터 호스팅 | 8083 |
| **Sync Service** | Java 17 + Spring | Kafka → DB 저장 | 8082 |
| **Kafka UI** | Provectus | 모니터링 대시보드 | 8081 |

---

## 2. 데이터 흐름

### 2.1 ASIS → TOBE 동기화 흐름

```
[1단계] ASIS에서 데이터 변경
┌─────────────────────────────────────────────────────────────┐
│  INSERT INTO BOOK_INFO (BOOK_ID, BOOK_TITLE, ...)           │
│  VALUES (100, '테스트도서', ...);                            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
[2단계] Debezium이 변경 감지 (LogMiner 사용)
┌─────────────────────────────────────────────────────────────┐
│  Debezium Connector가 Oracle Redo Log를 읽어서              │
│  변경 사항을 Kafka 토픽으로 전송                              │
│  → 토픽: asis.ASIS_USER.BOOK_INFO                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
[3단계] Sync Service가 Kafka 메시지 소비
┌─────────────────────────────────────────────────────────────┐
│  @KafkaListener가 메시지 수신                                │
│  → TOBE DB의 CDC_TOBE_BOOK 테이블에 INSERT                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
[4단계] WORKER 프로시저가 처리 (5초마다 자동 실행)
┌─────────────────────────────────────────────────────────────┐
│  SP_WORKER_BOOK 프로시저:                                    │
│                                                             │
│  (1) CDC → STAGING (스키마 변환)                             │
│      BOOK_TITLE → TITLE                                     │
│      'Y' → 1, 'N' → 0                                       │
│      '01' → 'LIT' (카테고리 코드 변환)                        │
│                                                             │
│  (2) STAGING → TB_BOOK (원본 테이블에 반영)                   │
│                                                             │
│  (3) 해시 기록 (무한루프 방지)                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
[5단계] 동기화 완료
┌─────────────────────────────────────────────────────────────┐
│  TOBE DB의 TB_BOOK 테이블에 데이터 반영 완료!                 │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 양방향 동기화 흐름도

```
┌─────────────┐                                    ┌─────────────┐
│    ASIS     │                                    │    TOBE     │
│   Oracle    │                                    │   Oracle    │
├─────────────┤                                    ├─────────────┤
│             │                                    │             │
│ BOOK_INFO   │───▶ Debezium ───▶ Kafka ───▶ Sync │ CDC_TOBE_*  │
│             │                   Service          │      │      │
│             │                                    │      ▼      │
│             │                                    │  STAGING_*  │
│             │                                    │      │      │
│             │                                    │   WORKER    │
│             │                                    │      │      │
│             │                                    │      ▼      │
│             │                                    │  TB_BOOK    │
│             │                                    │             │
├─────────────┤                                    ├─────────────┤
│             │                                    │             │
│ CDC_ASIS_*  │◀─── Sync ◀─── Kafka ◀─── Debezium─│  TB_BOOK    │
│      │      │     Service                        │             │
│      ▼      │                                    │             │
│  STAGING_*  │                                    │             │
│      │      │                                    │             │
│   WORKER    │                                    │             │
│      │      │                                    │             │
│      ▼      │                                    │             │
│ BOOK_INFO   │                                    │             │
│             │                                    │             │
└─────────────┘                                    └─────────────┘
```

---

## 3. 테이블 구조

### 3.1 3단계 처리 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    데이터 처리 3단계                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [1단계] CDC 테이블                                          │
│  ┌─────────────────────────────────────────┐               │
│  │ CDC_TOBE_BOOK                           │               │
│  │ - Kafka에서 받은 원본 데이터 저장          │               │
│  │ - ASIS 스키마 그대로 저장                 │               │
│  │ - PROCESSED_YN = 'N' (미처리 상태)       │               │
│  └─────────────────────────────────────────┘               │
│                         │                                   │
│                         ▼                                   │
│  [2단계] STAGING 테이블                                      │
│  ┌─────────────────────────────────────────┐               │
│  │ STAGING_TOBE_BOOK                       │               │
│  │ - 스키마 변환된 데이터 저장               │               │
│  │ - TOBE 스키마로 변환 완료                │               │
│  │ - 원본 반영 대기 상태                    │               │
│  └─────────────────────────────────────────┘               │
│                         │                                   │
│                         ▼                                   │
│  [3단계] 원본 테이블                                         │
│  ┌─────────────────────────────────────────┐               │
│  │ TB_BOOK (TOBE 원본 테이블)               │               │
│  │ - 최종 반영된 데이터                      │               │
│  │ - 애플리케이션에서 사용하는 테이블         │               │
│  └─────────────────────────────────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 원본 테이블 스키마 차이

**ASIS: BOOK_INFO**
```sql
CREATE TABLE BOOK_INFO (
    BOOK_ID     NUMBER PRIMARY KEY,
    BOOK_TITLE  VARCHAR2(200),
    AUTHOR      VARCHAR2(100),
    CATEGORY    VARCHAR2(2),      -- '01', '02', '03'
    STATUS      CHAR(1),          -- 'Y', 'N'
    REG_DATE    DATE
);
```

**TOBE: TB_BOOK**
```sql
CREATE TABLE TB_BOOK (
    BOOK_ID      NUMBER PRIMARY KEY,
    TITLE        VARCHAR2(500),
    AUTHOR_NAME  VARCHAR2(200),
    CATEGORY_CD  VARCHAR2(10),    -- 'LIT', 'SCI', 'HIS'
    IS_ACTIVE    NUMBER(1),       -- 1, 0
    CREATED_AT   TIMESTAMP
);
```

### 3.3 스키마 변환 규칙

| ASIS 컬럼 | TOBE 컬럼 | 변환 규칙 |
|----------|----------|----------|
| `BOOK_TITLE` | `TITLE` | 컬럼명 변경 |
| `AUTHOR` | `AUTHOR_NAME` | 컬럼명 변경 |
| `CATEGORY` ('01') | `CATEGORY_CD` ('LIT') | 코드값 변환 |
| `STATUS` ('Y') | `IS_ACTIVE` (1) | 타입+값 변환 |
| `REG_DATE` | `CREATED_AT` | 컬럼명+타입 변경 |

---

## 4. 무한루프 방지

### 4.1 문제 상황

양방향 동기화에서 발생하는 무한루프:

```
ASIS에서 INSERT
     ↓ CDC 감지
TOBE에 동기화 (TB_BOOK INSERT)
     ↓ CDC 감지 ← 여기서 다시 변경이 감지됨!
ASIS에 동기화 (BOOK_INFO INSERT)
     ↓ CDC 감지
TOBE에 동기화
     ↓
   ... 무한 반복 ...
```

### 4.2 해결책: 해시 기반 중복 감지

```
┌─────────────────────────────────────────────────────────────┐
│                    무한루프 방지 로직                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [1] 데이터 반영 시 해시 생성 & 저장                          │
│      HASH = SHA256(테이블명 + PK + 연산 + 데이터)            │
│      → CDC_PROCESSED_HASH 테이블에 저장                     │
│                                                             │
│  [2] CDC 데이터 처리 전 해시 체크                             │
│      IF 동일 해시가 5분 이내 존재 THEN                        │
│          → SKIP (무한루프로 판단)                            │
│          → PROCESSED_YN = 'S' (Skipped)                     │
│      ELSE                                                   │
│          → 정상 처리                                         │
│                                                             │
│  [3] 오래된 해시 정리 (10분 경과 시 삭제)                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 흐름도

```
CDC 데이터 수신
     ↓
해시 생성 (테이블+PK+연산+데이터)
     ↓
┌────────────────────────────┐
│ 5분 이내 동일 해시 존재?     │
└────────────────────────────┘
     │              │
    YES             NO
     ↓              ↓
  SKIP 처리      정상 처리
  (무한루프)      (원본 반영)
                    ↓
               해시 저장
```

---

## 5. WORKER 프로시저

### 5.1 처리 흐름

```
┌─────────────────────────────────────────────────────────────┐
│              SP_WORKER_BOOK 처리 흐름                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Oracle Scheduler Job (5초마다 실행)                         │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────┐                                        │
│  │ SP_RUN_ALL_WORKERS                                       │
│  │    │                                                     │
│  │    ├─▶ SP_CLEANUP_HASH (오래된 해시 정리)                 │
│  │    ├─▶ SP_WORKER_BOOK                                    │
│  │    ├─▶ SP_WORKER_MEMBER                                  │
│  │    └─▶ SP_WORKER_LEGACY_CODE                             │
│  └─────────────────┘                                        │
│                                                             │
│  SP_WORKER_BOOK 상세:                                        │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ [1단계] CDC → STAGING                                │    │
│  │     - 미처리 CDC 레코드 조회 (PROCESSED_YN = 'N')     │    │
│  │     - 무한루프 체크 (해시 비교)                       │    │
│  │     - 스키마 변환 후 STAGING에 INSERT                │    │
│  │     - CDC 레코드 처리 완료 표시                       │    │
│  └─────────────────────────────────────────────────────┘    │
│                       │                                     │
│                       ▼                                     │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ [2단계] STAGING → 원본 테이블                        │    │
│  │     - 미처리 STAGING 레코드 조회                     │    │
│  │     - OPERATION에 따라 INSERT/UPDATE/DELETE 실행    │    │
│  │     - 해시 기록 (무한루프 방지)                      │    │
│  │     - 동기화 로그 기록                              │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 왜 프로시저로 구현하나?

| 방식 | 장점 | 단점 |
|------|-----|------|
| **DB 프로시저** (현재 방식) | 트랜잭션 일관성, 네트워크 비용 없음 | DB 부하 |
| Java 애플리케이션 | 확장성, 디버깅 용이 | 네트워크 왕복 비용 |

**선택 이유**: 스키마 변환과 원본 반영을 하나의 트랜잭션으로 처리하기 위해

---

## 6. 접속 정보

### 6.1 서비스 URL

| 서비스 | URL | 용도 |
|--------|-----|------|
| **CDC 시뮬레이터** | http://localhost:8082/simulator | 테스트 UI |
| Kafka UI | http://localhost:8081 | Kafka 모니터링 |
| Kafka Connect API | http://localhost:8083 | 커넥터 관리 |

### 6.2 데이터베이스 접속 정보

| DB | 호스트:포트 | 사용자 | 비밀번호 |
|----|------------|--------|---------|
| ASIS Oracle | localhost:15210 | asis_user | asis123 |
| TOBE Oracle | localhost:15220 | tobe_user | tobe123 |

---

## 7. 다음 단계

1. **Debezium 상세** → [03_Debezium_핵심개념.md](03_Debezium_핵심개념.md)
2. **설계 상세** → [../02-설계/01_동기화_설계.md](../02-설계/01_동기화_설계.md)
3. **환경 시작하기** → [../00-시작하기/02_환경_시작_가이드.md](../00-시작하기/02_환경_시작_가이드.md)

---

*작성일: 2026-01-14*
