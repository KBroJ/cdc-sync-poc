# CDC PoC 실전 사용 가이드 (초보자용)

> **이 문서의 목적**: "뭘 어디서 어떻게 실행하는지" 하나도 모르는 상태에서도 따라할 수 있도록 작성했습니다.
>
> 모든 명령어에 대해 **어디서 실행하는지**, **왜 실행하는지**, **결과가 어떻게 나와야 하는지** 설명합니다.

---

## 목차

1. [시작하기 전에 알아야 할 것들](#1-시작하기-전에-알아야-할-것들)
2. [환경 시작하기](#2-환경-시작하기)
3. [모니터링 대시보드 사용법](#3-모니터링-대시보드-사용법)
4. [CDC 테스트 해보기](#4-cdc-테스트-해보기)
5. [Kafka UI 사용법](#5-kafka-ui-사용법)
6. [문제가 생겼을 때](#6-문제가-생겼을-때)
7. [명령어 레퍼런스](#7-명령어-레퍼런스)

---

## 1. 시작하기 전에 알아야 할 것들

### 1.1 "터미널"이 뭔가요?

**터미널** = 명령어를 입력해서 컴퓨터를 제어하는 프로그램

**Windows에서 터미널 여는 방법:**
1. `Win + R` 키 누르기
2. `cmd` 입력 후 엔터
3. 검은 창이 뜨면 성공!

또는:
1. 시작 메뉴에서 "Windows Terminal" 검색
2. 클릭해서 열기

### 1.2 "curl"이 뭔가요?

**curl** = 웹 요청을 보내는 명령어 도구

웹 브라우저로 `http://naver.com` 접속하는 것과 같은 일을 명령어로 할 수 있습니다.

```
브라우저: 주소창에 URL 입력 → 페이지 표시
curl: 터미널에서 curl 명령어 실행 → 결과를 텍스트로 표시
```

**curl 설치 확인:**
```bash
curl --version
```
→ 버전 정보가 나오면 설치되어 있음
→ "curl을 찾을 수 없습니다" 나오면 설치 필요

### 1.3 "Docker"가 뭔가요?

**Docker** = 가상 컴퓨터를 쉽게 만들어주는 도구

우리 PoC에서는 Oracle DB, Kafka 등을 각각의 "컨테이너"(작은 가상 컴퓨터)로 실행합니다.

**Docker Desktop 설치 확인:**
1. 시스템 트레이(오른쪽 아래)에 고래 아이콘이 있는지 확인
2. 없으면 Docker Desktop 설치 필요

### 1.4 이 PoC에서 사용하는 URL들

| 이름 | URL | 용도 |
|------|-----|------|
| **CDC 대시보드** | http://localhost:8082/dashboard | 우리가 만든 모니터링 화면 |
| Kafka UI | http://localhost:8081 | Kafka 메시지 확인 |
| Kafka Connect API | http://localhost:8083 | Debezium 설정 API |
| ASIS DB | localhost:1521 | SQL Developer로 접속 |
| TOBE DB | localhost:1522 | SQL Developer로 접속 |

---

## 2. 환경 시작하기

### 2.1 전체 환경 시작

**어디서 실행하나요?**
→ Windows 터미널 (또는 PowerShell)

**어떻게 실행하나요?**
```bash
cd C:\Work\CDC\poc
scripts\01_start_env.bat
```

**무슨 일이 일어나나요?**
1. 7개의 Docker 컨테이너가 시작됩니다
2. Oracle DB 초기화가 진행됩니다 (1-2분 소요)
3. 모든 서비스가 준비되면 완료 메시지가 나옵니다

**예상 결과:**
```
==========================================
 CDC PoC 환경 시작
==========================================
[1/3] Docker Compose 시작...
 ✔ Container asis-oracle   Started
 ✔ Container tobe-oracle   Started
 ✔ Container zookeeper     Started
 ✔ Container kafka         Started
 ✔ Container kafka-connect Started
 ✔ Container sync-service  Started
 ✔ Container kafka-ui      Started

ASIS Oracle 준비 완료!
TOBE Oracle 준비 완료!

==========================================
 환경 시작 완료!
==========================================
```

### 2.2 환경 상태 확인

**어디서 실행하나요?**
→ Windows 터미널

**어떻게 실행하나요?**
```bash
docker ps
```

**예상 결과:**
```
NAMES           STATUS                    PORTS
sync-service    Up 5 minutes (healthy)    0.0.0.0:8082->8080/tcp
kafka-connect   Up 10 minutes             0.0.0.0:8083->8083/tcp
kafka-ui        Up 10 minutes             0.0.0.0:8081->8080/tcp
kafka           Up 10 minutes             0.0.0.0:9092->9092/tcp
zookeeper       Up 10 minutes
asis-oracle     Up 10 minutes (healthy)   0.0.0.0:1521->1521/tcp
tobe-oracle     Up 10 minutes (healthy)   0.0.0.0:1522->1521/tcp
```

**결과 해석:**
- `(healthy)` = 정상 작동 중
- `Up X minutes` = X분 전에 시작됨
- 모든 7개가 있어야 정상

### 2.3 환경 중지

**어디서 실행하나요?**
→ Windows 터미널

**어떻게 실행하나요?**
```bash
cd C:\Work\CDC\poc
scripts\02_stop_env.bat
```

---

## 3. 모니터링 대시보드 사용법

### 3.1 대시보드 접속

**어디서 하나요?**
→ 웹 브라우저 (Chrome, Edge 등)

**어떻게 하나요?**
1. 브라우저 주소창에 입력: `http://localhost:8082/dashboard`
2. 엔터

**예상 화면:**
```
┌─────────────────────────────────────────────────────────┐
│           CDC 모니터링 대시보드                          │
├─────────────────────────────────────────────────────────┤
│                                                          │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │
│   │ 총 수신 │  │   성공  │  │   실패  │  │ 성공률  │   │
│   │    5    │  │    5    │  │    0    │  │  100%   │   │
│   └─────────┘  └─────────┘  └─────────┘  └─────────┘   │
│                                                          │
│   [테스트 패널]                                          │
│   Book ID: [1    ]  제목: [테스트     ]                 │
│   [ASIS 테스트]  [TOBE 테스트]  [에러 테스트]           │
│                                                          │
│   [최근 이벤트]                                          │
│   시간         상태    테이블        전송 데이터        │
│   16:20:15    SUCCESS CDC_TOBE_BOOK {BOOK_ID:1,...}    │
│   ...                                                    │
└─────────────────────────────────────────────────────────┘
```

### 3.2 테스트 버튼 사용

**ASIS 테스트 버튼을 누르면?**
1. ASIS DB의 BOOK_INFO 테이블에 UPDATE가 실행됩니다
2. Debezium이 이 변경을 감지합니다
3. Kafka로 메시지가 전송됩니다
4. Sync Service가 메시지를 받아서 TOBE DB의 CDC_TOBE_BOOK에 INSERT합니다
5. 대시보드의 "최근 이벤트"에 새 항목이 추가됩니다

**테스트 순서:**
1. Book ID 입력 (예: 1)
2. 제목 입력 (예: "테스트제목")
3. [ASIS 테스트] 버튼 클릭
4. 잠시 대기 (2-5초)
5. 최근 이벤트 목록 확인

### 3.3 전송 데이터 확인

대시보드의 "최근 이벤트" 테이블에서 **데이터** 컬럼을 보면:
```
{BOOK_ID: 1, BOOK_TITLE: "테스트제목", AUTHOR: "허균", ...}
```

이것이 실제로 CDC를 통해 전송된 데이터입니다.

---

## 4. CDC 테스트 해보기

### 4.1 방법 1: 대시보드에서 테스트 (가장 쉬움)

위의 3.2 참고

### 4.2 방법 2: SQL Developer에서 직접 테스트

**전제조건:**
- SQL Developer (또는 DBeaver) 설치되어 있어야 함

**단계 1: ASIS DB 접속**
```
호스트: localhost
포트: 1521
서비스명: XEPDB1
사용자: asis_user
비밀번호: asis123
```

**단계 2: UPDATE 실행**
```sql
UPDATE BOOK_INFO SET BOOK_TITLE = '직접테스트' WHERE BOOK_ID = 1;
COMMIT;
```

**단계 3: 대시보드에서 확인**
- http://localhost:8082/dashboard 새로고침
- 최근 이벤트에 새 항목이 추가되었는지 확인

**단계 4: TOBE DB에서 확인**
```
호스트: localhost
포트: 1522  (← 1521이 아님!)
서비스명: XEPDB1
사용자: tobe_user
비밀번호: tobe123
```

```sql
SELECT * FROM CDC_TOBE_BOOK ORDER BY CDC_SEQ DESC;
```

### 4.3 방법 3: curl 명령어로 테스트 (API 이해용)

**어디서 실행하나요?**
→ Windows 터미널

**왜 이렇게 하나요?**
- 대시보드의 테스트 버튼을 누르면 내부적으로 이 API가 호출됩니다
- API를 직접 호출해보면 시스템 동작을 더 잘 이해할 수 있습니다

**ASIS UPDATE 테스트:**
```bash
curl -X POST http://localhost:8082/api/test/asis/update
```

**예상 결과:**
```json
{
  "success": true,
  "message": "ASIS DB UPDATE 완료",
  "detail": {
    "table": "BOOK_INFO",
    "bookId": 1,
    "newTitle": "테스트-1768288332252",
    "rowsAffected": 1
  }
}
```

**결과 해석:**
- `success: true` = 성공
- `rowsAffected: 1` = 1개 행이 업데이트됨
- `newTitle` = 변경된 제목 (자동 생성됨)

**현재 데이터 조회:**
```bash
curl http://localhost:8082/api/test/asis/data
```

**TOBE CDC 테이블 조회:**
```bash
curl http://localhost:8082/api/test/tobe/cdc
```

---

## 5. Kafka UI 사용법

### 5.1 Kafka UI 접속

**어디서 하나요?**
→ 웹 브라우저

**어떻게 하나요?**
1. 주소창에 입력: `http://localhost:8081`
2. 엔터

### 5.2 토픽(Topic) 확인하기

**토픽이 뭔가요?**
- Kafka에서 메시지가 저장되는 "채널" 또는 "폴더" 같은 것
- 테이블별로 토픽이 생성됩니다

**토픽 목록 확인:**
1. 왼쪽 메뉴에서 "Topics" 클릭
2. 생성된 토픽들이 표시됩니다:
   - `asis.ASIS_USER.BOOK_INFO` ← ASIS의 BOOK_INFO 테이블 변경
   - `asis.ASIS_USER.MEMBER_INFO` ← ASIS의 MEMBER_INFO 테이블 변경
   - `tobe.TOBE_USER.TB_BOOK` ← TOBE의 TB_BOOK 테이블 변경

### 5.3 메시지 내용 보기

1. 토픽 이름 클릭 (예: `asis.ASIS_USER.BOOK_INFO`)
2. "Messages" 탭 클릭
3. 메시지 목록이 표시됩니다
4. 하나를 클릭하면 상세 내용:

```json
{
  "payload": {
    "op": "u",            ← 작업 유형 (u=UPDATE)
    "before": {...},       ← 변경 전 데이터
    "after": {            ← 변경 후 데이터
      "BOOK_ID": 1,
      "BOOK_TITLE": "새제목",
      ...
    }
  }
}
```

### 5.4 커넥터 상태 확인

**커넥터가 뭔가요?**
- Debezium이 Oracle에 연결해서 변경사항을 감지하는 설정
- "asis-oracle-connector"와 "tobe-oracle-connector"가 등록되어 있어야 합니다

**확인 방법:**
1. 왼쪽 메뉴에서 "Kafka Connect" 클릭
2. Connectors 목록 확인
3. 각 커넥터가 "RUNNING" 상태인지 확인

---

## 6. 문제가 생겼을 때

### 6.1 "localhost:8082에 연결할 수 없습니다"

**원인:** sync-service 컨테이너가 실행 중이 아님

**확인:**
```bash
docker ps | findstr sync-service
```

**해결:**
```bash
cd C:\Work\CDC\poc
docker compose up -d sync-service
```

### 6.2 "대시보드가 비어있어요"

**원인:** CDC 이벤트가 아직 없음 (서비스 재시작 후 등)

**해결:**
1. 대시보드에서 "ASIS 테스트" 버튼 클릭
2. 5초 정도 대기
3. 새로고침

### 6.3 "테스트 버튼을 눌러도 아무것도 안 나와요"

**원인 1:** Debezium 커넥터가 등록되지 않음

**확인:**
```bash
curl http://localhost:8083/connectors
```

**예상 결과:**
```json
["asis-oracle-connector","tobe-oracle-connector"]
```

**빈 배열 `[]`이 나오면:**
커넥터를 등록해야 합니다. (아래 6.4 참고)

**원인 2:** Kafka 연결 문제

**확인:**
```bash
docker logs sync-service --tail 20
```

에러 메시지가 있는지 확인

### 6.4 Debezium 커넥터 등록하기

**왜 필요한가요?**
- Debezium이 Oracle DB를 감시하려면 "커넥터"를 등록해야 합니다
- 환경 첫 시작 시 또는 커넥터가 삭제된 경우 필요

**어디서 실행하나요?**
→ Windows 터미널

**ASIS 커넥터 등록:**
```bash
curl -X POST http://localhost:8083/connectors ^
  -H "Content-Type: application/json" ^
  -d "{\"name\":\"asis-oracle-connector\",\"config\":{\"connector.class\":\"io.debezium.connector.oracle.OracleConnector\",\"database.hostname\":\"asis-oracle\",\"database.port\":\"1521\",\"database.user\":\"c##dbzuser\",\"database.password\":\"dbz\",\"database.dbname\":\"XE\",\"database.pdb.name\":\"XEPDB1\",\"topic.prefix\":\"asis\",\"schema.include.list\":\"ASIS_USER\",\"table.include.list\":\"ASIS_USER.BOOK_INFO,ASIS_USER.MEMBER_INFO,ASIS_USER.LEGACY_CODE\",\"schema.history.internal.kafka.bootstrap.servers\":\"kafka:29092\",\"schema.history.internal.kafka.topic\":\"schema-changes.asis\",\"log.mining.strategy\":\"online_catalog\"}}"
```

> 위 명령어가 너무 길다면, PowerShell에서 실행하거나 Kafka UI의 Connect 메뉴에서 직접 등록할 수도 있습니다.

**등록 확인:**
```bash
curl http://localhost:8083/connectors
```

### 6.5 컨테이너 로그 확인

**어디서 실행하나요?**
→ Windows 터미널

**sync-service 로그:**
```bash
docker logs sync-service --tail 50
```

**Kafka Connect 로그:**
```bash
docker logs kafka-connect --tail 50
```

**Oracle 로그:**
```bash
docker logs asis-oracle --tail 50
```

---

## 7. 명령어 레퍼런스

### 7.1 자주 쓰는 Docker 명령어

| 명령어 | 설명 | 예시 |
|--------|------|------|
| `docker ps` | 실행 중인 컨테이너 목록 | `docker ps` |
| `docker logs [이름]` | 컨테이너 로그 보기 | `docker logs sync-service` |
| `docker logs [이름] --tail N` | 마지막 N줄만 보기 | `docker logs sync-service --tail 20` |
| `docker logs [이름] -f` | 실시간 로그 보기 (Ctrl+C로 종료) | `docker logs sync-service -f` |
| `docker restart [이름]` | 컨테이너 재시작 | `docker restart sync-service` |
| `docker exec -it [이름] bash` | 컨테이너 안으로 들어가기 | `docker exec -it asis-oracle bash` |

### 7.2 자주 쓰는 curl 명령어

**기본 형식:**
```bash
curl [옵션] [URL]
```

**옵션 설명:**
| 옵션 | 설명 |
|------|------|
| `-X POST` | POST 방식으로 요청 (데이터 전송) |
| `-X GET` | GET 방식으로 요청 (조회) - 기본값 |
| `-H "헤더"` | HTTP 헤더 추가 |
| `-d "데이터"` | 전송할 데이터 |
| `-s` | 진행 표시 숨기기 (silent) |

**이 PoC에서 사용하는 curl 명령어들:**

```bash
# 1. Sync Service 상태 확인
curl http://localhost:8082/actuator/health

# 2. 모니터링 통계 조회
curl http://localhost:8082/api/monitoring/stats

# 3. 최근 이벤트 조회
curl http://localhost:8082/api/monitoring/events

# 4. ASIS 테스트 실행
curl -X POST http://localhost:8082/api/test/asis/update

# 5. TOBE 테스트 실행
curl -X POST http://localhost:8082/api/test/tobe/update

# 6. 커넥터 목록 조회
curl http://localhost:8083/connectors

# 7. 커넥터 상태 확인
curl http://localhost:8083/connectors/asis-oracle-connector/status
```

### 7.3 결과를 보기 좋게 출력하기

JSON 결과를 보기 좋게 출력하려면:

**Windows PowerShell:**
```powershell
curl http://localhost:8082/api/monitoring/stats | ConvertFrom-Json | ConvertTo-Json -Depth 10
```

**또는 jq 설치 후:**
```bash
curl http://localhost:8082/api/monitoring/stats | jq
```

---

## 부록: 이 PoC에서 일어나는 일 정리

### 전체 흐름 (1분 요약)

```
1. ASIS DB에서 UPDATE 발생
   ↓
2. Oracle이 Redo Log에 기록 (자동)
   ↓
3. Debezium이 LogMiner로 Redo Log 읽기 (실시간)
   ↓
4. Kafka 토픽에 메시지 발행
   ↓
5. Sync Service가 메시지 수신
   ↓
6. TOBE DB의 CDC 테이블에 INSERT
   ↓
7. 나중에 WORKER가 처리하면 TOBE 원본 테이블에 반영
```

### 각 컨테이너의 역할

| 컨테이너 | 역할 | 비유 |
|----------|------|------|
| asis-oracle | 원본 데이터 (ASIS 시스템) | 기존 은행 |
| tobe-oracle | 대상 데이터 (TOBE 시스템) | 새 은행 |
| kafka | 메시지 전달 | 우체국 |
| kafka-connect | Debezium 실행 | 감시자 |
| sync-service | 메시지 처리 | 배달원 |
| kafka-ui | 모니터링 | CCTV |
| zookeeper | Kafka 관리 | 관리자 |

---

> **다음 단계:** 실제로 한번 테스트해보세요!
> 1. 환경 시작: `scripts\01_start_env.bat`
> 2. 대시보드 접속: http://localhost:8082/dashboard
> 3. ASIS 테스트 버튼 클릭
> 4. 결과 확인!
