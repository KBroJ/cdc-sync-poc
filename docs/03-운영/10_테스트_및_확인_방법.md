# CDC PoC 테스트 및 확인 가이드

> 이 문서는 CDC가 제대로 동작하는지 **무엇을 보고**, **어떻게 확인**하는지 단계별로 설명합니다.

---

## 목차

1. [전체 테스트 흐름 요약](#1-전체-테스트-흐름-요약)
2. [환경 상태 확인](#2-환경-상태-확인)
3. [CDC 테스트 실행](#3-cdc-테스트-실행)
4. [각 단계별 확인 방법](#4-각-단계별-확인-방법)
5. [문제 발생 시 디버깅](#5-문제-발생-시-디버깅)

---

## 1. 전체 테스트 흐름 요약

### 1.1 테스트 단계

```
[단계 1] 환경 상태 확인
    ↓
[단계 2] ASIS DB에서 데이터 변경 (UPDATE)
    ↓
[단계 3] Kafka 토픽에 이벤트 도착 확인
    ↓
[단계 4] Sync Service 로그에서 처리 확인
    ↓
[단계 5] TOBE DB의 CDC 테이블에 데이터 도착 확인
```

### 1.2 확인 포인트 체크리스트

| 단계 | 확인 항목 | 확인 명령어 |
|:----:|----------|-------------|
| 1 | 컨테이너 실행 상태 | `docker compose ps` |
| 1 | Debezium 커넥터 상태 | `curl localhost:8083/connectors/*/status` |
| 2 | ASIS DB 변경 실행 | SQL 실행 |
| 3 | Kafka 토픽 메시지 | `kafka-console-consumer` |
| 4 | Sync Service 로그 | `docker logs sync-service` |
| 5 | TOBE CDC 테이블 | SQL 조회 |

---

## 2. 환경 상태 확인

### 2.1 컨테이너 상태 확인

```bash
cd C:\Work\CDC\poc
docker compose ps
```

**정상 상태:**
```
NAME            IMAGE                             STATUS
asis-oracle     gvenzl/oracle-xe:21-slim          Up (healthy)     ← healthy 확인
tobe-oracle     gvenzl/oracle-xe:21-slim          Up (healthy)     ← healthy 확인
kafka           confluentinc/cp-kafka:7.5.0       Up
kafka-connect   debezium/connect:2.4              Up
sync-service    poc-sync-service-java             Up (healthy)     ← healthy 확인
kafka-ui        provectuslabs/kafka-ui:latest     Up
zookeeper       confluentinc/cp-zookeeper:7.5.0   Up
```

**확인 포인트:**
- Oracle 컨테이너가 `(healthy)` 상태인지
- sync-service가 `(healthy)` 상태인지
- 모든 컨테이너가 `Up` 상태인지

**문제 시:**
```bash
# 특정 컨테이너 로그 확인
docker logs asis-oracle --tail 50

# 컨테이너 재시작
docker compose restart asis-oracle
```

### 2.2 Debezium 커넥터 상태 확인

```bash
# 등록된 커넥터 목록
curl -s http://localhost:8083/connectors | python -m json.tool
```

**정상 결과:**
```json
[
    "asis-oracle-connector",
    "tobe-oracle-connector"
]
```

```bash
# ASIS 커넥터 상태 확인
curl -s http://localhost:8083/connectors/asis-oracle-connector/status | python -m json.tool
```

**정상 결과:**
```json
{
    "name": "asis-oracle-connector",
    "connector": {
        "state": "RUNNING",         ← RUNNING 확인
        "worker_id": "172.18.0.7:8083"
    },
    "tasks": [
        {
            "id": 0,
            "state": "RUNNING",     ← RUNNING 확인
            "worker_id": "172.18.0.7:8083"
        }
    ],
    "type": "source"
}
```

**확인 포인트:**
- `connector.state`가 `RUNNING`인지
- `tasks[0].state`가 `RUNNING`인지

**문제 시 (FAILED 상태):**
```bash
# 에러 메시지 확인
curl -s http://localhost:8083/connectors/asis-oracle-connector/status | python -m json.tool

# tasks[0].trace 에서 에러 상세 확인

# 커넥터 재시작
curl -X POST http://localhost:8083/connectors/asis-oracle-connector/restart
```

### 2.3 Sync Service Health 확인

```bash
curl -s http://localhost:8082/actuator/health | python -m json.tool
```

**정상 결과:**
```json
{
    "status": "UP",
    "components": {
        "diskSpace": {
            "status": "UP"
        },
        "ping": {
            "status": "UP"
        }
    }
}
```

**확인 포인트:**
- 최상위 `status`가 `UP`인지

---

## 3. CDC 테스트 실행

### 3.1 ASIS DB 접속

**방법 1: Docker 내부에서 실행**
```bash
docker exec -it asis-oracle sqlplus asis_user/asis123@//localhost:1521/XEPDB1
```

**방법 2: 호스트에서 SQL 직접 실행**
```bash
docker exec -i asis-oracle sqlplus -s asis_user/asis123@//localhost:1521/XEPDB1 <<EOF
-- SQL 명령어
EOF
```

**방법 3: DBeaver/SQL Developer 사용**
```
Host: localhost
Port: 1521
Service: XEPDB1
User: asis_user
Password: asis123
```

### 3.2 현재 데이터 확인

```sql
-- BOOK_INFO 테이블 조회
SELECT BOOK_ID, BOOK_TITLE, AUTHOR, STATUS FROM BOOK_INFO;
```

**결과 예시:**
```
   BOOK_ID BOOK_TITLE                     AUTHOR       S
---------- ------------------------------ ------------ -
         1 CDC성공테스트                   허균         Y
         2 상대성이론                      아인슈타인   Y
         3 조선왕조실록                    미상         Y
```

### 3.3 데이터 변경 (UPDATE)

```sql
-- BOOK_ID=1의 제목 변경
UPDATE BOOK_INFO SET BOOK_TITLE = '새로운제목-테스트' WHERE BOOK_ID = 1;
COMMIT;

-- 변경 확인
SELECT BOOK_ID, BOOK_TITLE FROM BOOK_INFO WHERE BOOK_ID = 1;
```

**결과:**
```
   BOOK_ID BOOK_TITLE
---------- ------------------------------
         1 새로운제목-테스트
```

---

## 4. 각 단계별 확인 방법

### 4.1 Kafka 토픽에 이벤트 도착 확인

```bash
# asis.ASIS_USER.BOOK_INFO 토픽의 최신 메시지 확인
docker exec kafka kafka-console-consumer \
    --bootstrap-server localhost:9092 \
    --topic asis.ASIS_USER.BOOK_INFO \
    --from-beginning \
    --max-messages 1 \
    --timeout-ms 5000
```

**정상 결과 (JSON 형식):**
```json
{
  "payload": {
    "op": "u",                          // u = UPDATE
    "before": {
      "BOOK_ID": {"scale":0,"value":"AQ=="},
      "BOOK_TITLE": "기존제목"           // 변경 전
    },
    "after": {
      "BOOK_ID": {"scale":0,"value":"AQ=="},
      "BOOK_TITLE": "새로운제목-테스트"   // 변경 후
    },
    "source": {
      "table": "BOOK_INFO",
      "schema": "ASIS_USER"
    }
  }
}
```

**확인 포인트:**
- `op`가 `u` (UPDATE)인지
- `before`에 변경 전 값이 있는지
- `after`에 변경 후 값이 있는지

**메시지가 없다면:**
1. Debezium 커넥터 상태 확인
2. LogMiner 설정 확인
3. 테이블이 `table.include.list`에 포함되어 있는지 확인

### 4.2 Sync Service 로그 확인

```bash
# 최근 30줄 로그 확인
docker logs sync-service --tail 30
```

**성공 시 로그:**
```
2026-01-13 06:06:13 [KafkaListenerEndpoint...] DEBUG c.cdc.sync.consumer.CdcKafkaConsumer - Parsed CDC event: CdcEvent{op=UPDATE, table=BOOK_INFO, hash=aa5713d6499a3a08}
2026-01-13 06:06:14 [KafkaListenerEndpoint...] INFO  com.cdc.sync.service.CdcSyncService - [ASIS->TOBE] Inserted into CDC_TOBE_BOOK: UPDATE - hash=aa5713d6499a3a08
```

**확인 포인트:**
- `Parsed CDC event` 로그가 있는지 (이벤트 수신 확인)
- `Inserted into CDC_TOBE_BOOK` 로그가 있는지 (DB 삽입 확인)

**실패 시 로그:**
```
ERROR com.cdc.sync.service.CdcSyncService - [ASIS->TOBE] Failed to insert into CDC_TOBE_BOOK: ...
```

**에러별 대응:**
| 에러 메시지 | 원인 | 해결 |
|------------|------|------|
| `Connection refused` | DB 연결 불가 | Oracle 컨테이너 상태 확인 |
| `ORA-00942: table not found` | CDC 테이블 없음 | 초기화 SQL 확인 |
| `ORA-00932: inconsistent datatypes` | 타입 불일치 | 코드 수정 필요 |

### 4.3 TOBE DB CDC 테이블 확인

```bash
docker exec -i tobe-oracle sqlplus -s tobe_user/tobe123@//localhost:1521/XEPDB1 <<EOF
SET LINESIZE 200
COL OPERATION FORMAT A10
COL BOOK_TITLE FORMAT A25
COL CHANGE_HASH FORMAT A18

SELECT CDC_SEQ, OPERATION, BOOK_ID, BOOK_TITLE, PROCESSED_YN,
       SUBSTR(CHANGE_HASH, 1, 16) AS CHANGE_HASH
FROM CDC_TOBE_BOOK
ORDER BY CDC_SEQ DESC
FETCH FIRST 5 ROWS ONLY;
EOF
```

**정상 결과:**
```
   CDC_SEQ OPERATION     BOOK_ID BOOK_TITLE                P CHANGE_HASH
---------- ---------- ---------- ------------------------- - ------------------
         3 UPDATE              1 새로운제목-테스트         N aa5713d6499a3a08
         2 UPDATE              3 CDC성공테스트             N c70a58025100d95c
         1 UPDATE              2 상대성이론               N b3f2a1c8d7e9f0a1
```

**확인 포인트:**
- 새로 추가된 레코드가 있는지
- `BOOK_TITLE`이 변경한 값과 일치하는지
- `PROCESSED_YN`이 `N`인지 (아직 WORKER 미실행)

---

## 5. 문제 발생 시 디버깅

### 5.1 문제 진단 플로우차트

```
데이터 변경했는데 CDC 테이블에 안 보인다?
                    │
                    ▼
    ┌───────────────────────────────┐
    │ Kafka 토픽에 메시지가 있나?   │
    └───────────────┬───────────────┘
                    │
          ┌────────┴────────┐
          ▼                 ▼
       없다               있다
          │                 │
          ▼                 ▼
    ┌─────────────┐   ┌─────────────────────┐
    │ Debezium    │   │ Sync Service 로그에  │
    │ 커넥터 확인 │   │ 처리 로그가 있나?   │
    └─────────────┘   └──────────┬──────────┘
                               │
                    ┌─────────┴─────────┐
                    ▼                   ▼
                 없다                 있다
                    │                   │
                    ▼                   ▼
            ┌───────────────┐   ┌───────────────┐
            │ Kafka 연결    │   │ 에러 로그     │
            │ 확인          │   │ 확인          │
            └───────────────┘   └───────────────┘
```

### 5.2 Debezium 커넥터 문제

**증상:** Kafka 토픽에 메시지가 없다

**확인 1: 커넥터 상태**
```bash
curl -s http://localhost:8083/connectors/asis-oracle-connector/status | python -m json.tool
```

**확인 2: 커넥터가 FAILED 상태라면**
```bash
# 에러 상세 확인
curl -s http://localhost:8083/connectors/asis-oracle-connector/status \
  | python -c "import sys,json; print(json.load(sys.stdin)['tasks'][0].get('trace','No trace'))"
```

**확인 3: Kafka Connect 로그**
```bash
docker logs kafka-connect --tail 100 | grep -i error
```

**일반적인 문제:**
| 에러 | 원인 | 해결 |
|------|------|------|
| `ORA-01031: insufficient privileges` | 권한 부족 | LogMiner 권한 부여 |
| `ORA-44609: CONTINUOUS_MINE` | Oracle 21c 비호환 | 해당 옵션 제거 |
| `No suitable driver` | JDBC 드라이버 없음 | ojdbc11.jar 추가 |

### 5.3 Sync Service 문제

**증상:** Kafka 메시지는 있는데 CDC 테이블에 없다

**확인 1: Sync Service 로그**
```bash
docker logs sync-service --tail 50 | grep -E "(ERROR|WARN|Failed)"
```

**확인 2: Consumer Group 상태**
```bash
docker exec kafka kafka-consumer-groups.sh \
    --bootstrap-server localhost:9092 \
    --describe \
    --group cdc-sync-service
```

**결과 해석:**
```
TOPIC                        PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG
asis.ASIS_USER.BOOK_INFO     0          10              10              0
```

- `LAG`: 처리 안 된 메시지 수
- `LAG`가 계속 증가하면 Consumer 문제

### 5.4 실시간 로그 모니터링

```bash
# Sync Service 실시간 로그
docker logs -f sync-service

# 특정 키워드만 필터링
docker logs -f sync-service 2>&1 | grep -E "(Inserted|Failed|ERROR)"
```

---

## 6. 전체 테스트 스크립트

### 6.1 한 번에 테스트하기 (Windows)

```batch
@echo off
echo === CDC 테스트 시작 ===

echo.
echo [1/5] 컨테이너 상태 확인
docker compose ps --format "table {{.Name}}\t{{.Status}}"

echo.
echo [2/5] Debezium 커넥터 상태
curl -s http://localhost:8083/connectors/asis-oracle-connector/status | findstr state

echo.
echo [3/5] ASIS DB 데이터 변경
docker exec -i asis-oracle sqlplus -s asis_user/asis123@//localhost:1521/XEPDB1 ^
  < scripts\test_update.sql

echo.
echo [4/5] 5초 대기...
timeout /t 5 /nobreak > nul

echo.
echo [5/5] TOBE CDC 테이블 확인
docker exec -i tobe-oracle sqlplus -s tobe_user/tobe123@//localhost:1521/XEPDB1 ^
  < scripts\check_cdc.sql

echo.
echo === 테스트 완료 ===
```

### 6.2 test_update.sql

```sql
UPDATE BOOK_INFO SET BOOK_TITLE = 'CDC자동테스트-' || TO_CHAR(SYSDATE, 'HHMISS') WHERE BOOK_ID = 1;
COMMIT;
SELECT 'Updated BOOK_ID=1 at ' || TO_CHAR(SYSDATE, 'HH24:MI:SS') AS RESULT FROM DUAL;
EXIT;
```

### 6.3 check_cdc.sql

```sql
SET LINESIZE 200
COL BOOK_TITLE FORMAT A30

SELECT CDC_SEQ, OPERATION, BOOK_ID, BOOK_TITLE, PROCESSED_YN
FROM CDC_TOBE_BOOK
ORDER BY CDC_SEQ DESC
FETCH FIRST 3 ROWS ONLY;
EXIT;
```

---

## 7. Kafka UI로 확인하기

### 7.1 Kafka UI 접속

브라우저에서: **http://localhost:8081**

### 7.2 화면 설명

```
┌──────────────────────────────────────────────────────────┐
│  Kafka UI                                                │
├──────────────────────────────────────────────────────────┤
│  Dashboard                                               │
│  ├─ Topics        ← 토픽 목록 및 메시지 확인            │
│  ├─ Consumers     ← Consumer Group 상태                 │
│  ├─ Brokers       ← Kafka 브로커 상태                   │
│  └─ Connectors    ← Debezium 커넥터 상태                │
└──────────────────────────────────────────────────────────┘
```

### 7.3 토픽 메시지 확인

1. 좌측 메뉴에서 **Topics** 클릭
2. `asis.ASIS_USER.BOOK_INFO` 토픽 클릭
3. **Messages** 탭 클릭
4. **Seek Type**: `Newest` 선택
5. **Submit** 버튼 클릭

**메시지 내용:**
```json
{
  "payload": {
    "op": "u",
    "before": { "BOOK_TITLE": "기존값" },
    "after": { "BOOK_TITLE": "변경값" }
  }
}
```

### 7.4 Consumer Group 상태 확인

1. 좌측 메뉴에서 **Consumers** 클릭
2. `cdc-sync-service` 그룹 클릭
3. **LAG** 컬럼 확인

| Consumer Group | LAG | 의미 |
|----------------|-----|------|
| cdc-sync-service | 0 | 모든 메시지 처리 완료 |
| cdc-sync-service | 5+ | 5개 메시지 처리 대기 중 |

---

## 8. 요약: 빠른 확인 명령어

```bash
# 1. 전체 상태 한눈에 보기
docker compose ps

# 2. Debezium 커넥터 상태
curl -s http://localhost:8083/connectors/asis-oracle-connector/status | findstr state

# 3. Sync Service 최근 로그
docker logs sync-service --tail 10

# 4. TOBE CDC 테이블 최신 데이터
docker exec -i tobe-oracle sqlplus -s tobe_user/tobe123@//localhost:1521/XEPDB1 <<EOF
SELECT * FROM CDC_TOBE_BOOK ORDER BY CDC_SEQ DESC FETCH FIRST 3 ROWS ONLY;
EOF

# 5. Kafka UI
# 브라우저: http://localhost:8081
```

---

> **다음 문서:** [14_모니터링_대시보드.md](14_모니터링_대시보드.md) - 모니터링 기능 구현
