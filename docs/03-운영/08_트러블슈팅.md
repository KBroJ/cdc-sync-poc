# CDC PoC 트러블슈팅 가이드

> 이 문서는 CDC PoC 환경에서 발생할 수 있는 문제와 해결 방법을 설명합니다.

---

## 1. 컨테이너 문제

### 1.1 Oracle 컨테이너가 시작되지 않음

**증상:**
```
docker compose ps
# asis-oracle이 Exited 상태
```

**원인 1: 메모리 부족**

```bash
# 로그 확인
docker logs asis-oracle

# "Out of memory" 또는 "Cannot allocate memory" 메시지
```

**해결:**
1. Docker Desktop → Settings → Resources
2. Memory를 최소 4GB 이상으로 설정
3. 컨테이너 재시작: `docker compose restart asis-oracle`

**원인 2: 포트 충돌**

```bash
# 로그에서 "Address already in use" 확인
netstat -ano | findstr "1521"
```

**해결:**
```yaml
# docker-compose.yml에서 포트 변경
ports:
  - "1523:1521"  # 다른 포트 사용
```

### 1.2 Kafka Connect가 시작되지 않음

**증상:**
```bash
curl http://localhost:8083/connectors
# 연결 거부
```

**원인: Kafka 미준비 상태에서 시작**

**해결:**
```bash
# Kafka 상태 확인
docker logs kafka | tail -20

# Kafka Connect 재시작
docker compose restart kafka-connect

# 또는 순차적으로 시작
docker compose up -d zookeeper
sleep 10
docker compose up -d kafka
sleep 20
docker compose up -d kafka-connect
```

---

## 2. Debezium 커넥터 문제

### 2.1 커넥터 FAILED 상태

**증상:**
```bash
curl http://localhost:8083/connectors/asis-oracle-connector/status
# "state": "FAILED"
```

**확인 방법:**
```bash
# 에러 메시지 확인
curl -s http://localhost:8083/connectors/asis-oracle-connector/status | jq '.tasks[0].trace'
```

---

### 2.2 ORA-44609: CONTINUOUS_MINE is desupported

**증상:**
```
java.sql.SQLException: ORA-44609: CONTINOUS_MINE is desupported for use with DBMS_LOGMNR.START_LOGMNR.
```

**원인:** Oracle 19c부터 CONTINUOUS_MINE 옵션 제거됨

**해결:**
```bash
# 커넥터 삭제
curl -X DELETE http://localhost:8083/connectors/asis-oracle-connector

# continuous_mine 옵션 없이 재등록
curl -X POST http://localhost:8083/connectors \
  -H "Content-Type: application/json" \
  -d '{
    "name": "asis-oracle-connector",
    "config": {
      "connector.class": "io.debezium.connector.oracle.OracleConnector",
      ...
      "log.mining.strategy": "online_catalog"
      // "log.mining.continuous.mine": "true"  ← 이 옵션 제거
    }
  }'
```

---

### 2.3 No suitable driver found for jdbc:oracle

**증상:**
```
java.sql.SQLException: No suitable driver found for jdbc:oracle:thin:@asis-oracle:1521/XE
```

**원인:** Oracle JDBC 드라이버 미설치

**해결:**
```bash
# 1. 드라이버 다운로드
curl -L -o poc/kafka-connect/libs/ojdbc11.jar \
  "https://repo1.maven.org/maven2/com/oracle/database/jdbc/ojdbc11/23.3.0.23.09/ojdbc11-23.3.0.23.09.jar"

# 2. docker-compose.yml 확인
kafka-connect:
  volumes:
    - ./kafka-connect/libs/ojdbc11.jar:/kafka/libs/ojdbc11.jar

# 3. 컨테이너 재시작
docker compose up -d kafka-connect
```

---

### 2.4 ORA-01031: insufficient privileges

**증상:**
```
ORA-01031: insufficient privileges
```

**원인:** LogMiner 권한 부족

**해결:**
```sql
-- sysdba로 접속
docker exec -i asis-oracle bash -c 'export ORACLE_SID=XE && sqlplus / as sysdba'

-- 누락된 권한 부여
GRANT LOGMINING TO c##dbzuser CONTAINER=ALL;
GRANT SELECT ON V_$LOGMNR_CONTENTS TO c##dbzuser CONTAINER=ALL;
GRANT EXECUTE ON DBMS_LOGMNR TO c##dbzuser CONTAINER=ALL;
```

---

### 2.5 테이블이 캡처되지 않음

**증상:** 데이터 변경해도 Kafka 토픽에 메시지 없음

**확인 1: 테이블 목록**
```bash
curl -s http://localhost:8083/connectors/asis-oracle-connector/config | jq '.["table.include.list"]'
```

**확인 2: Supplemental Logging**
```sql
-- 테이블 레벨 supplemental logging 확인
SELECT LOG_GROUP_NAME, TABLE_NAME, ALWAYS
FROM DBA_LOG_GROUPS
WHERE OWNER = 'ASIS_USER';

-- 활성화
ALTER TABLE ASIS_USER.BOOK_INFO ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;
```

**확인 3: 커넥터 재시작**
```bash
curl -X POST http://localhost:8083/connectors/asis-oracle-connector/restart
```

---

## 3. Sync Service 문제

### 3.1 DB 연결 실패

**증상:**
```
docker logs sync-service
# Connection refused 또는 Connection timed out
```

**해결:**
```bash
# 1. Oracle 컨테이너 상태 확인
docker exec asis-oracle healthcheck.sh

# 2. 네트워크 연결 테스트
docker exec sync-service ping -c 2 asis-oracle

# 3. 환경변수 확인
docker exec sync-service env | grep DB

# 4. 재시작
docker compose restart sync-service
```

### 3.2 Kafka 연결 실패

**증상:**
```
NoBrokersAvailable
```

**해결:**
```bash
# 1. Kafka 상태 확인
docker logs kafka | tail -20

# 2. 네트워크 테스트
docker exec sync-service nc -zv kafka 29092

# 3. 환경변수 확인 (kafka:29092 여야 함)
docker exec sync-service env | grep KAFKA

# 4. Sync Service 재시작 (Kafka 완전 시작 후)
docker compose restart sync-service
```

### 3.3 메시지 처리 에러

**증상:**
```
Failed to parse Debezium message
```

**확인:**
```bash
# 상세 로그 확인
docker logs sync-service 2>&1 | grep -A5 "Failed to parse"
```

**해결:** Debezium 메시지 형식 확인 후 파서 수정

---

## 4. 데이터 문제

### 4.1 CDC 테이블에 데이터가 안 들어옴

**확인 순서:**

```bash
# 1. 커넥터 상태
curl http://localhost:8083/connectors/asis-oracle-connector/status

# 2. Kafka 토픽에 메시지 있는지
docker exec kafka kafka-console-consumer \
  --bootstrap-server localhost:9092 \
  --topic asis.ASIS_USER.BOOK_INFO \
  --from-beginning --max-messages 1

# 3. Sync Service 로그
docker logs sync-service | tail -50

# 4. Consumer 그룹 상태
docker exec kafka kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --describe --group cdc-sync-service
```

### 4.2 스키마 변환 오류

**증상:** CDC 테이블에 데이터는 있지만 WORKER 실패

**확인:**
```sql
-- 에러 메시지 확인
SELECT CDC_SEQ, ERROR_MSG
FROM CDC_TOBE_BOOK
WHERE PROCESSED_YN = 'E';
```

**해결:**
1. 코드 매핑 테이블 확인 (CODE_MAPPING)
2. 누락된 매핑 추가
3. WORKER 재실행

### 4.3 무한루프 발생

**증상:** 같은 데이터가 계속 동기화됨

**확인:**
```sql
-- 동일 해시 확인
SELECT CHANGE_HASH, COUNT(*)
FROM CDC_TOBE_BOOK
GROUP BY CHANGE_HASH
HAVING COUNT(*) > 1;
```

**해결:**
1. CHANGE_HASH 기반 중복 체크 로직 확인
2. WORKER의 FN_IS_LOOP 함수 확인
3. HASH_LOG 테이블 데이터 확인

---

## 5. 성능 문제

### 5.1 동기화 지연

**증상:** 변경 후 CDC 테이블에 나타나기까지 오래 걸림

**확인:**
```bash
# Consumer Lag 확인
docker exec kafka kafka-consumer-groups.sh \
  --bootstrap-server localhost:9092 \
  --describe --group cdc-sync-service
```

**해결:**
1. Sync Service 인스턴스 증가
2. Kafka 파티션 증가
3. DB 커넥션 풀 조정

### 5.2 메모리 부족

**증상:**
```
java.lang.OutOfMemoryError
```

**해결:**
```yaml
# docker-compose.yml
sync-service:
  environment:
    JAVA_OPTS: "-Xms512m -Xmx1024m"
```

---

## 6. 로그 확인 명령어 모음

```bash
# 전체 컨테이너 상태
docker compose ps

# 각 컨테이너 로그
docker logs asis-oracle --tail 50
docker logs tobe-oracle --tail 50
docker logs kafka --tail 50
docker logs kafka-connect --tail 50
docker logs sync-service --tail 50

# 실시간 로그 (Ctrl+C로 종료)
docker logs -f sync-service

# 특정 문자열 검색
docker logs sync-service 2>&1 | grep -i error
docker logs kafka-connect 2>&1 | grep -i exception

# 커넥터 상태
curl -s http://localhost:8083/connectors | jq
curl -s http://localhost:8083/connectors/asis-oracle-connector/status | jq
```

---

## 7. 전체 환경 초기화

문제 해결이 어려울 때 처음부터 다시 시작:

```bash
# 1. 모든 컨테이너 및 볼륨 삭제
docker compose down -v

# 2. 이미지 캐시 정리 (선택)
docker system prune -f

# 3. 다시 시작
docker compose up -d

# 4. Oracle 준비 대기 (약 2-3분)
docker logs -f asis-oracle

# 5. LogMiner 설정 (문서 참조)

# 6. 커넥터 등록 (문서 참조)
```

---

## 8. 도움 요청 시 수집할 정보

문제 해결이 안 될 때 다음 정보를 수집하세요:

```bash
# 1. 컨테이너 상태
docker compose ps > container_status.txt

# 2. 각 서비스 로그
docker logs asis-oracle > asis_oracle.log 2>&1
docker logs kafka-connect > kafka_connect.log 2>&1
docker logs sync-service > sync_service.log 2>&1

# 3. 커넥터 상태
curl -s http://localhost:8083/connectors/asis-oracle-connector/status > connector_status.json

# 4. 환경 정보
docker version > docker_version.txt
```

---

> **문서 끝** - 문제가 해결되지 않으면 구축 로그([07_CDC_PoC_구축_로그.md](07_CDC_PoC_구축_로그.md))를 참조하세요.
