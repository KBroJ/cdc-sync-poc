<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDC 동기화 시뮬레이터</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e;
            color: #eee;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 { color: #00d4ff; font-size: 1.8em; margin-bottom: 5px; }
        .header .subtitle { color: #888; font-size: 0.9em; }

        /* 테이블 선택 영역 */
        .table-selector {
            background: #16213e;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .table-selector label {
            color: #888;
            font-size: 0.9em;
        }
        .table-selector select {
            background: #0d0d1a;
            border: 1px solid #333;
            color: #fff;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            min-width: 150px;
        }
        .table-selector select:focus {
            outline: none;
            border-color: #00d4ff;
        }
        .direction-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .direction-badge.bidirectional { background: #6c5ce7; color: #fff; }
        .direction-badge.asis-to-tobe { background: #00b894; color: #fff; }
        .direction-badge.tobe-to-asis { background: #fdcb6e; color: #1a1a2e; }
        .table-info {
            color: #888;
            font-size: 0.85em;
        }
        .table-info span { color: #00d4ff; }

        /* 탭 네비게이션 */
        .tab-nav {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 0;
        }
        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #888;
            font-size: 1em;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        .tab-btn:hover {
            color: #00d4ff;
        }
        .tab-btn.active {
            color: #00d4ff;
            border-bottom-color: #00d4ff;
        }

        /* 탭 컨텐츠 */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* 섹션 스타일 */
        .section {
            background: #16213e;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .section-title {
            color: #00d4ff;
            font-size: 1.1em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 버튼 스타일 */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-size: 0.85em;
        }
        .btn:hover { transform: scale(1.05); }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-primary { background: #00d4ff; color: #1a1a2e; }
        .btn-success { background: #00ff88; color: #1a1a2e; }
        .btn-warning { background: #ffa502; color: #1a1a2e; }
        .btn-danger { background: #ff4757; color: #fff; }
        .btn-secondary { background: #444; color: #fff; }
        .btn-insert { background: #00d4ff; color: #1a1a2e; }
        .btn-update { background: #ffa502; color: #1a1a2e; }
        .btn-delete { background: #ff4757; color: #fff; }

        /* 그리드 */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 1200px) {
            .grid-2 { grid-template-columns: 1fr; }
        }

        /* 테스트 패널 */
        .test-panel {
            background: #0d0d1a;
            border-radius: 8px;
            padding: 15px;
        }
        .test-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        .test-panel-header h4 {
            margin: 0;
        }
        .test-panel.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .test-panel.disabled::after {
            content: '이 방향은 테스트 불가';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 10px 20px;
            border-radius: 8px;
            color: #888;
        }

        /* 입력 폼 */
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .input-group label {
            color: #888;
            min-width: 80px;
            font-size: 0.9em;
        }
        .input-group input {
            background: #16213e;
            border: 1px solid #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            flex: 1;
        }
        .input-group input:focus {
            outline: none;
            border-color: #00d4ff;
        }
        .test-buttons {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        /* 결과 표시 */
        .test-result {
            background: #16213e;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-result.show { display: block; }
        .test-result.success { border-left: 3px solid #00ff88; }
        .test-result.error { border-left: 3px solid #ff4757; }
        .result-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .result-badge.success { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        .result-badge.error { background: rgba(255, 71, 87, 0.2); color: #ff4757; }

        /* 테이블 스타일 */
        .table-wrapper {
            max-height: 250px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        th {
            position: sticky;
            top: 0;
            background: #0d0d1a;
            color: #00d4ff;
            font-weight: 600;
            padding: 12px 8px;
            text-align: left;
            z-index: 10;
            border-bottom: 2px solid #00d4ff;
        }
        td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        tr:hover td { background: #1a1a2e; }
        tr[onclick]:hover td { background: #0d4d6d; cursor: pointer; }

        /* 상태 배지 */
        .status-badge {
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .status-success { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
        .status-failed { background: rgba(255, 71, 87, 0.2); color: #ff4757; }
        .status-pending { background: rgba(255, 165, 2, 0.2); color: #ffa502; }
        .status-blocked { background: rgba(108, 92, 231, 0.2); color: #6c5ce7; }
        .status-loop_blocked { background: rgba(108, 92, 231, 0.2); color: #6c5ce7; }
        .status-target_not_found { background: rgba(255, 193, 7, 0.2); color: #ffc107; }

        .op-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: bold;
        }
        .op-insert { background: #00d4ff33; color: #00d4ff; }
        .op-update { background: #ffa50233; color: #ffa502; }
        .op-delete { background: #ff475733; color: #ff4757; }

        /* 동기화 흐름 */
        .flow-container {
            display: flex;
            align-items: stretch;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }
        .flow-step {
            flex: 1;
            min-width: 200px;
            background: #0d0d1a;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .flow-step-title {
            color: #888;
            font-size: 0.8em;
            margin-bottom: 8px;
        }
        .flow-step-table {
            color: #00d4ff;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .flow-arrow {
            display: flex;
            align-items: center;
            color: #00d4ff;
            font-size: 1.5em;
        }

        /* 통계 카드 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid #333;
        }
        .stat-card.success { border-left: 4px solid #00ff88; }
        .stat-card.failed { border-left: 4px solid #ff4757; }
        .stat-card.total { border-left: 4px solid #00d4ff; }
        .stat-card.blocked { border-left: 4px solid #6c5ce7; }
        .stat-value { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .stat-card.success .stat-value { color: #00ff88; }
        .stat-card.failed .stat-value { color: #ff4757; }
        .stat-card.total .stat-value { color: #00d4ff; }
        .stat-card.blocked .stat-value { color: #6c5ce7; }
        .stat-label { color: #888; font-size: 0.85em; }

        /* 컨트롤 영역 */
        .controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
        }

        .no-data {
            text-align: center;
            color: #666;
            padding: 30px;
        }

        /* 안내 박스 */
        .info-box {
            background: #0d0d1a;
            border-left: 3px solid #ffa502;
            padding: 12px 15px;
            margin-bottom: 15px;
            font-size: 0.85em;
            color: #aaa;
        }
        .info-box strong { color: #ffa502; }
    </style>
</head>
<body>
    <div class="header">
        <h1>CDC 동기화 시뮬레이터</h1>
        <p class="subtitle">동기화 흐름 테스트 및 검증 도구</p>
    </div>

    <!-- 테이블 선택 -->
    <div class="table-selector">
        <label>테이블 선택:</label>
        <select id="tableSelect" onchange="changeTable(this.value)">
            <option th:each="table : ${tables}"
                    th:value="${table.name}"
                    th:text="${table.displayName + ' (' + table.name + ')'}"
                    th:selected="${table.name == selectedTable.name}">
            </option>
        </select>

        <span class="direction-badge"
              th:classappend="${selectedTable.direction.name() == 'BIDIRECTIONAL'} ? 'bidirectional' : (${selectedTable.direction.name() == 'ASIS_TO_TOBE'} ? 'asis-to-tobe' : 'tobe-to-asis')"
              th:text="${selectedTable.directionIcon + ' ' + selectedTable.directionDisplay}">
        </span>

        <span class="table-info">
            ASIS: <span th:text="${selectedTable.asis.table}">BOOK_INFO</span>
            <span th:text="${selectedTable.directionIcon}"></span>
            TOBE: <span th:text="${selectedTable.tobe.table}">TB_BOOK</span>
        </span>
    </div>

    <!-- 탭 네비게이션 -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="showTab('test')">테스트 실행</button>
        <button class="tab-btn" onclick="showTab('flow')">동기화 흐름</button>
        <button class="tab-btn" onclick="showTab('history')">이력/통계</button>
    </div>

    <!-- Tab 1: 테스트 실행 -->
    <div id="tab-test" class="tab-content active">
        <div class="info-box">
            <strong>테스트 흐름:</strong> 원본 테이블에 CUD 실행 -> Debezium 감지 -> Kafka 전송 -> CDC 테이블 INSERT -> WORKER (5초) -> STAGING -> 대상 테이블 반영
        </div>

        <div class="grid-2">
            <!-- ASIS 테스트 패널 -->
            <div class="section">
                <div class="section-title" style="color: #00ff88;">
                    ASIS에서 테스트 (구 -> 신)
                </div>
                <div class="test-panel" th:classappend="${!selectedTable.asisTestable} ? 'disabled' : ''">
                    <div class="test-panel-header">
                        <h4 th:text="${selectedTable.asis.table}">BOOK_INFO</h4>
                        <span style="color:#666; font-size:0.8em;"
                              th:text="'-> ' + ${selectedTable.cdcTable?.tobe ?: 'N/A'}">-> CDC_TOBE_BOOK</span>
                    </div>

                    <!-- 동적 입력 폼 -->
                    <div th:each="col : ${selectedTable.asis.columns}" class="input-group">
                        <label th:text="${col.display + ':'}">컬럼:</label>
                        <input th:type="${col.type == 'NUMBER'} ? 'number' : 'text'"
                               th:id="'asis_' + ${col.name}"
                               th:name="${col.name}"
                               th:placeholder="${col.display + (col.required ? ' (필수)' : '')}"
                               th:required="${col.required}">
                    </div>

                    <div class="test-buttons">
                        <button class="btn btn-insert" onclick="runTest('asis', 'insert')"
                                th:disabled="${!selectedTable.asisTestable}">INSERT</button>
                        <button class="btn btn-update" onclick="runTest('asis', 'update')"
                                th:disabled="${!selectedTable.asisTestable}">UPDATE</button>
                        <button class="btn btn-delete" onclick="runTest('asis', 'delete')"
                                th:disabled="${!selectedTable.asisTestable}">DELETE</button>
                    </div>
                    <div id="asisResult" class="test-result"></div>
                </div>
            </div>

            <!-- TOBE 테스트 패널 -->
            <div class="section">
                <div class="section-title" style="color: #ffa502;">
                    TOBE에서 테스트 (신 -> 구)
                </div>
                <div class="test-panel" th:classappend="${!selectedTable.tobeTestable} ? 'disabled' : ''">
                    <div class="test-panel-header">
                        <h4 th:text="${selectedTable.tobe.table}">TB_BOOK</h4>
                        <span style="color:#666; font-size:0.8em;"
                              th:text="'-> ' + ${selectedTable.cdcTable?.asis ?: 'N/A'}">-> CDC_ASIS_BOOK</span>
                    </div>

                    <!-- 동적 입력 폼 -->
                    <div th:each="col : ${selectedTable.tobe.columns}" class="input-group">
                        <label th:text="${col.display + ':'}">컬럼:</label>
                        <input th:type="${col.type == 'NUMBER'} ? 'number' : 'text'"
                               th:id="'tobe_' + ${col.name}"
                               th:name="${col.name}"
                               th:placeholder="${col.display + (col.required ? ' (필수)' : '')}"
                               th:required="${col.required}">
                    </div>

                    <div class="test-buttons">
                        <button class="btn btn-insert" onclick="runTest('tobe', 'insert')"
                                th:disabled="${!selectedTable.tobeTestable}">INSERT</button>
                        <button class="btn btn-update" onclick="runTest('tobe', 'update')"
                                th:disabled="${!selectedTable.tobeTestable}">UPDATE</button>
                        <button class="btn btn-delete" onclick="runTest('tobe', 'delete')"
                                th:disabled="${!selectedTable.tobeTestable}">DELETE</button>
                    </div>
                    <div id="tobeResult" class="test-result"></div>
                </div>
            </div>
        </div>

        <!-- 원본 테이블 현황 -->
        <div class="grid-2">
            <div class="section">
                <div class="section-title">
                    ASIS 원본 테이블 (<span th:text="${selectedTable.asis.table}">BOOK_INFO</span>)
                </div>
                <div class="controls">
                    <button class="btn btn-secondary" onclick="loadTableData('asis')">새로고침</button>
                </div>
                <div class="table-wrapper">
                    <table id="asisDataTable">
                        <thead>
                            <tr>
                                <th th:each="col : ${selectedTable.asis.columns}" th:text="${col.name}">COL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td th:colspan="${selectedTable.asis.columns.size()}" class="no-data">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="section">
                <div class="section-title">
                    TOBE 원본 테이블 (<span th:text="${selectedTable.tobe.table}">TB_BOOK</span>)
                </div>
                <div class="controls">
                    <button class="btn btn-secondary" onclick="loadTableData('tobe')">새로고침</button>
                </div>
                <div class="table-wrapper">
                    <table id="tobeDataTable">
                        <thead>
                            <tr>
                                <th th:each="col : ${selectedTable.tobe.columns}" th:text="${col.name}">COL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td th:colspan="${selectedTable.tobe.columns.size()}" class="no-data">로딩 중...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 2: 동기화 흐름 -->
    <div id="tab-flow" class="tab-content">
        <div class="info-box">
            <strong>동기화 흐름 확인:</strong> 테스트 실행 후 각 단계별 데이터 상태를 확인할 수 있습니다. WORKER는 5초마다 자동 실행됩니다.
        </div>

        <!-- 흐름 조회 컨트롤 바 -->
        <div class="flow-controls" style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 12px 15px; background: #16213e; border-radius: 8px;">
            <button class="btn btn-primary" onclick="loadAllFlowData()" id="btnRefreshAll">
                전체 새로고침
            </button>
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="color: #888; font-size: 0.9em;">자동 새로고침:</label>
                <button class="btn btn-secondary" onclick="toggleAutoRefresh()" id="btnAutoRefresh" style="min-width: 60px;">
                    OFF
                </button>
                <select id="refreshInterval" style="background: #0d0d1a; border: 1px solid #333; color: #fff; padding: 6px 10px; border-radius: 4px;" onchange="updateRefreshInterval()">
                    <option value="3000">3초</option>
                    <option value="5000" selected>5초</option>
                    <option value="10000">10초</option>
                </select>
            </div>
            <span id="lastRefreshTime" style="color: #666; font-size: 0.85em; margin-left: auto;">
                마지막 조회: -
            </span>
        </div>

        <!-- ASIS -> TOBE 흐름 -->
        <div class="section" th:if="${selectedTable.asisTestable}">
            <div class="section-title" style="color: #00ff88;">구 -> 신 동기화 흐름</div>
            <div class="flow-container">
                <div class="flow-step">
                    <div class="flow-step-title">1. ASIS 원본</div>
                    <div class="flow-step-table" th:text="${selectedTable.asis.table}">BOOK_INFO</div>
                    <div id="flow-asis-source" class="table-wrapper" style="margin-top:10px; max-height:150px;"></div>
                </div>
                <div class="flow-arrow">-></div>
                <div class="flow-step">
                    <div class="flow-step-title">2. CDC 테이블</div>
                    <div class="flow-step-table" th:text="${selectedTable.cdcTable?.tobe}">CDC_TOBE_BOOK</div>
                    <div id="flow-tobe-cdc" class="table-wrapper" style="margin-top:10px; max-height:150px;"></div>
                </div>
                <div class="flow-arrow">-></div>
                <div class="flow-step">
                    <div class="flow-step-title">3. STAGING 테이블</div>
                    <div class="flow-step-table" th:text="${selectedTable.stagingTable?.tobe}">STAGING_TOBE_BOOK</div>
                    <div id="flow-tobe-staging" class="table-wrapper" style="margin-top:10px; max-height:150px;"></div>
                </div>
                <div class="flow-arrow">-></div>
                <div class="flow-step">
                    <div class="flow-step-title">4. TOBE 원본</div>
                    <div class="flow-step-table" th:text="${selectedTable.tobe.table}">TB_BOOK</div>
                    <div id="flow-tobe-source" class="table-wrapper" style="margin-top:10px; max-height:150px;"></div>
                </div>
            </div>
        </div>

        <!-- TOBE -> ASIS 흐름 -->
        <div class="section" th:if="${selectedTable.tobeTestable}">
            <div class="section-title" style="color: #ffa502;">신 -> 구 동기화 흐름</div>
            <div class="flow-container">
                <div class="flow-step">
                    <div class="flow-step-title">1. TOBE 원본</div>
                    <div class="flow-step-table" th:text="${selectedTable.tobe.table}">TB_BOOK</div>
                    <div id="flow-tobe-source2" class="table-wrapper" style="margin-top:10px; max-height:150px;"></div>
                </div>
                <div class="flow-arrow">-></div>
                <div class="flow-step">
                    <div class="flow-step-title">2. CDC 테이블</div>
                    <div class="flow-step-table" th:text="${selectedTable.cdcTable?.asis}">CDC_ASIS_BOOK</div>
                    <div id="flow-asis-cdc" class="table-wrapper" style="margin-top:10px; max-height:150px;"></div>
                </div>
                <div class="flow-arrow">-></div>
                <div class="flow-step">
                    <div class="flow-step-title">3. STAGING 테이블</div>
                    <div class="flow-step-table" th:text="${selectedTable.stagingTable?.asis}">STAGING_ASIS_BOOK</div>
                    <div id="flow-asis-staging" class="table-wrapper" style="margin-top:10px; max-height:150px;"></div>
                </div>
                <div class="flow-arrow">-></div>
                <div class="flow-step">
                    <div class="flow-step-title">4. ASIS 원본</div>
                    <div class="flow-step-table" th:text="${selectedTable.asis.table}">BOOK_INFO</div>
                    <div id="flow-asis-source2" class="table-wrapper" style="margin-top:10px; max-height:150px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab 3: 이력/통계 -->
    <div id="tab-history" class="tab-content">
        <!-- 통계 카드 -->
        <div class="stats-container">
            <div class="stat-card total">
                <div class="stat-value" id="statTotal">-</div>
                <div class="stat-label">총 동기화</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" id="statSuccess">-</div>
                <div class="stat-label">성공</div>
            </div>
            <div class="stat-card failed">
                <div class="stat-value" id="statFailed">-</div>
                <div class="stat-label">실패</div>
            </div>
            <div class="stat-card blocked">
                <div class="stat-value" id="statBlocked">-</div>
                <div class="stat-label">루프 차단</div>
            </div>
        </div>

        <!-- 동기화 이력 -->
        <div class="section">
            <div class="section-title">동기화 이력 (CDC_SYNC_LOG)</div>
            <div class="controls">
                <button class="btn btn-secondary" onclick="loadSyncLog()">새로고침</button>
            </div>
            <div class="table-wrapper" style="max-height: 400px;">
                <table id="syncLogTable">
                    <thead>
                        <tr>
                            <th>시간</th>
                            <th>방향</th>
                            <th>테이블</th>
                            <th>작업</th>
                            <th>PK</th>
                            <th>상태</th>
                            <th>에러메시지</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" class="no-data">로딩 중...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // 현재 선택된 테이블 정보
        const currentTable = /*[[${selectedTable.name}]]*/ 'BOOK';
        const asisColumns = /*[[${selectedTable.asis.columns}]]*/ [];
        const tobeColumns = /*[[${selectedTable.tobe.columns}]]*/ [];
        const asisPk = /*[[${selectedTable.asis.pk}]]*/ 'BOOK_ID';
        const tobePk = /*[[${selectedTable.tobe.pk}]]*/ 'BOOK_ID';

        // 테이블 변경
        function changeTable(tableName) {
            window.location.href = '/simulator?table=' + tableName;
        }

        // 탭 전환
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');

            // 탭별 데이터 로드
            if (tabName === 'flow') {
                // 동기화 흐름 탭: 전체 데이터 자동 로드
                loadAllFlowData();
            } else if (tabName === 'history') {
                loadSyncLog();
                loadStats();
            }

            // flow 탭이 아니면 자동 새로고침 중지
            if (tabName !== 'flow' && autoRefreshEnabled) {
                toggleAutoRefresh(); // OFF로 전환
            }
        }

        // 테스트 실행
        async function runTest(db, operation) {
            const resultDiv = document.getElementById(db + 'Result');
            resultDiv.className = 'test-result show';
            resultDiv.innerHTML = '<div style="color:#888;">실행 중...</div>';

            // 입력값 수집
            const columns = db === 'asis' ? asisColumns : tobeColumns;
            const data = {};
            columns.forEach(col => {
                const input = document.getElementById(db + '_' + col.name);
                if (input && input.value) {
                    // 원래 컬럼명(대문자) 유지
                    data[col.name] = input.value;
                }
            });

            try {
                // 새 SimulatorController API 사용
                const response = await fetch(`/api/simulator/${currentTable}/${db}/${operation}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                resultDiv.className = 'test-result show ' + (result.success ? 'success' : 'error');
                resultDiv.innerHTML = formatResult(result);

                // 3초 후 테이블 새로고침
                setTimeout(() => {
                    loadTableData('asis');
                    loadTableData('tobe');
                }, 3000);

            } catch (error) {
                resultDiv.className = 'test-result show error';
                resultDiv.innerHTML = `<span class="result-badge error">실패</span><p>에러: ${error.message}</p>`;
            }
        }

        // 결과 포맷팅
        function formatResult(result) {
            let html = `<span class="result-badge ${result.success ? 'success' : 'error'}">${result.success ? '성공' : '실패'}</span>`;
            html += `<p style="color:#aaa; margin:10px 0;">${result.message || ''}</p>`;

            if (result.table) {
                html += `<p style="color:#00d4ff; font-size:0.85em; margin:5px 0;">테이블: ${result.table}</p>`;
            }

            if (result.sql) {
                html += `<div style="background:#0d0d1a; padding:10px; border-radius:4px; margin:10px 0; font-family:monospace; font-size:0.85em; color:#888; word-break:break-all;">${result.sql}</div>`;
            }

            // INSERT 결과 (sentData 또는 insertedData)
            const insertData = result.sentData || result.insertedData;
            if (insertData) {
                html += `<div style="margin:10px 0;"><strong style="color:#00ff88;">INSERT 데이터:</strong><pre style="background:#0d0d1a; padding:10px; border-radius:4px; margin-top:5px; font-size:0.85em;">${JSON.stringify(insertData, null, 2)}</pre></div>`;
            }

            // UPDATE 결과
            if (result.beforeData && result.afterData) {
                html += `<div style="margin:10px 0;"><strong>변경 전:</strong><pre style="background:#0d0d1a; padding:10px; border-radius:4px; margin-top:5px; font-size:0.85em;">${JSON.stringify(result.beforeData, null, 2)}</pre></div>`;
                html += `<div style="margin:10px 0;"><strong style="color:#ffa502;">변경 후:</strong><pre style="background:#0d0d1a; padding:10px; border-radius:4px; margin-top:5px; font-size:0.85em;">${JSON.stringify(result.afterData, null, 2)}</pre></div>`;
            }

            // DELETE 결과
            if (result.deletedData) {
                html += `<div style="margin:10px 0;"><strong style="color:#ff4757;">삭제 데이터:</strong><pre style="background:#0d0d1a; padding:10px; border-radius:4px; margin-top:5px; font-size:0.85em;">${JSON.stringify(result.deletedData, null, 2)}</pre></div>`;
            }

            if (result.targetCdcTable) {
                html += `<p style="color:#666; font-size:0.85em; margin-top:10px;">CDC 대상 테이블: ${result.targetCdcTable}</p>`;
            }

            if (result.rowsAffected !== undefined) {
                html += `<p style="color:#888; font-size:0.85em;">영향받은 행: ${result.rowsAffected}</p>`;
            }

            return html;
        }

        // 테이블 데이터 로드
        async function loadTableData(db) {
            try {
                // 새 SimulatorController API 사용
                const response = await fetch(`/api/simulator/${currentTable}/${db}/data`);
                const result = await response.json();
                const tbody = document.querySelector(`#${db}DataTable tbody`);

                if (result.success && result.data && result.data.length > 0) {
                    const columns = db === 'asis' ? asisColumns : tobeColumns;
                    tbody.innerHTML = result.data.map((row, idx) => {
                        // 행 클릭 시 입력 폼에 자동 세팅 (JSON 이스케이프)
                        const rowJson = JSON.stringify(row).replace(/'/g, "\\'");
                        return `<tr style="cursor:pointer;" onclick="fillInputFromRow('${db}', '${rowJson}')" title="클릭하여 입력 폼에 세팅">` +
                            columns.map(col => `<td>${row[col.name] ?? '-'}</td>`).join('') + '</tr>';
                    }).join('');
                } else {
                    const colCount = db === 'asis' ? asisColumns.length : tobeColumns.length;
                    tbody.innerHTML = `<tr><td colspan="${colCount}" class="no-data">데이터 없음</td></tr>`;
                }
            } catch (error) {
                console.error(`${db} 데이터 로딩 실패:`, error);
            }
        }

        /**
         * 테이블 행 클릭 시 입력 폼에 자동 세팅
         * @param {string} db - 'asis' 또는 'tobe'
         * @param {string} rowJson - JSON 문자열로 인코딩된 행 데이터
         */
        function fillInputFromRow(db, rowJson) {
            try {
                const row = JSON.parse(rowJson);
                const columns = db === 'asis' ? asisColumns : tobeColumns;

                columns.forEach(col => {
                    const input = document.getElementById(db + '_' + col.name);
                    if (input && row[col.name] !== undefined && row[col.name] !== null) {
                        input.value = row[col.name];
                    }
                });

                // 시각적 피드백
                const panel = document.querySelector(`#tab-test .grid-2 > div:${db === 'asis' ? 'first' : 'last'}-child .test-panel`);
                if (panel) {
                    panel.style.transition = 'box-shadow 0.3s';
                    panel.style.boxShadow = '0 0 10px #00d4ff';
                    setTimeout(() => panel.style.boxShadow = '', 500);
                }
            } catch (e) {
                console.error('입력 폼 세팅 실패:', e);
            }
        }

        // 동기화 흐름 데이터 로드
        async function loadFlowData(db, type) {
            const containerId = `flow-${db}-${type}`;
            let container = document.getElementById(containerId);
            // 중복 ID 처리 (flow-tobe-source2, flow-asis-source2 등)
            if (!container) {
                container = document.getElementById(containerId + '2');
            }
            if (!container) return;

            try {
                // 모든 흐름 데이터를 SimulatorController에서 조회
                let url;
                switch (type) {
                    case 'source':
                        url = `/api/simulator/${currentTable}/${db}/data`;
                        break;
                    case 'cdc':
                        url = `/api/simulator/${currentTable}/${db}/cdc`;
                        break;
                    case 'staging':
                        url = `/api/simulator/${currentTable}/${db}/staging`;
                        break;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    const keys = Object.keys(result.data[0]).slice(0, 5);
                    let html = '<table><thead><tr>' + keys.map(k => `<th>${k}</th>`).join('') + '</tr></thead><tbody>';
                    html += result.data.slice(0, 5).map(row => {
                        return '<tr>' + keys.map(k => `<td>${row[k] ?? '-'}</td>`).join('') + '</tr>';
                    }).join('');
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p class="no-data">데이터 없음</p>';
                }
            } catch (error) {
                container.innerHTML = `<p class="no-data">로드 실패</p>`;
            }
        }

        // ============================================================
        // 전체 새로고침 및 자동 새로고침 기능
        // 학습 포인트: Promise.all을 사용한 병렬 API 호출
        // ============================================================

        // 자동 새로고침 상태 관리
        let autoRefreshEnabled = false;
        let autoRefreshTimer = null;

        /**
         * 전체 흐름 데이터 한번에 조회
         * - ASIS→TOBE 방향: asis/source → tobe/cdc → tobe/staging → tobe/source
         * - TOBE→ASIS 방향: tobe/source → asis/cdc → asis/staging → asis/source
         *
         * Promise.all 사용 이유:
         * - 4개 API를 순차 호출하면 약 200ms x 4 = 800ms
         * - 병렬 호출하면 약 200ms (가장 느린 것 기준)
         */
        async function loadAllFlowData() {
            const btn = document.getElementById('btnRefreshAll');
            btn.textContent = '조회 중...';
            btn.disabled = true;

            try {
                // 방향에 따라 조회할 항목 결정
                const asisTestable = /*[[${selectedTable.asisTestable}]]*/ true;
                const tobeTestable = /*[[${selectedTable.tobeTestable}]]*/ true;

                const promises = [];

                // ASIS → TOBE 흐름 (구→신)
                if (asisTestable) {
                    promises.push(
                        loadFlowData('asis', 'source'),
                        loadFlowData('tobe', 'cdc'),
                        loadFlowData('tobe', 'staging'),
                        loadFlowData('tobe', 'source')
                    );
                }

                // TOBE → ASIS 흐름 (신→구)
                if (tobeTestable) {
                    promises.push(
                        loadFlowData('tobe', 'source'),
                        loadFlowData('asis', 'cdc'),
                        loadFlowData('asis', 'staging'),
                        loadFlowData('asis', 'source')
                    );
                }

                // 모든 API 병렬 호출
                await Promise.all(promises);

                // 마지막 조회 시간 표시
                const now = new Date();
                const timeStr = now.toLocaleTimeString('ko-KR');
                document.getElementById('lastRefreshTime').textContent = `마지막 조회: ${timeStr}`;

            } catch (error) {
                console.error('전체 조회 실패:', error);
            } finally {
                btn.textContent = '전체 새로고침';
                btn.disabled = false;
            }
        }

        /**
         * 자동 새로고침 토글
         * 학습 포인트: setInterval/clearInterval을 사용한 주기적 실행
         */
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('btnAutoRefresh');

            if (autoRefreshEnabled) {
                btn.textContent = 'ON';
                btn.style.background = '#00d4ff';
                btn.style.color = '#1a1a2e';

                // 즉시 한번 실행
                loadAllFlowData();

                // 주기적 실행 시작
                const interval = parseInt(document.getElementById('refreshInterval').value);
                autoRefreshTimer = setInterval(loadAllFlowData, interval);
            } else {
                btn.textContent = 'OFF';
                btn.style.background = '#444';
                btn.style.color = '#fff';

                // 타이머 중지
                if (autoRefreshTimer) {
                    clearInterval(autoRefreshTimer);
                    autoRefreshTimer = null;
                }
            }
        }

        /**
         * 새로고침 간격 변경
         * 자동 새로고침 중이면 타이머 재설정
         */
        function updateRefreshInterval() {
            if (autoRefreshEnabled && autoRefreshTimer) {
                clearInterval(autoRefreshTimer);
                const interval = parseInt(document.getElementById('refreshInterval').value);
                autoRefreshTimer = setInterval(loadAllFlowData, interval);
            }
        }

        // 동기화 이력 로드
        async function loadSyncLog() {
            try {
                // 새 SimulatorController API 사용
                const response = await fetch(`/api/simulator/sync-log?table=${currentTable}`);
                const result = await response.json();
                const tbody = document.querySelector('#syncLogTable tbody');

                if (result.success && result.data && result.data.length > 0) {
                    tbody.innerHTML = result.data.map(row => `
                        <tr>
                            <td>${formatTimestamp(row.LOG_TIME) || '-'}</td>
                            <td>${row.DIRECTION || '-'}</td>
                            <td>${row.TABLE_NAME || '-'}</td>
                            <td><span class="op-badge op-${(row.OPERATION || '').toLowerCase()}">${row.OPERATION || '-'}</span></td>
                            <td>${row.PK_VALUE || '-'}</td>
                            <td><span class="status-badge status-${(row.STATUS || '').toLowerCase()}">${row.STATUS || '-'}</span></td>
                            <td style="color:#ff4757; font-size:0.85em;">${row.ERROR_MSG || '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="no-data">이력 없음</td></tr>';
                }
            } catch (error) {
                console.error('동기화 이력 로딩 실패:', error);
            }
        }

        // 타임스탬프 포맷팅
        function formatTimestamp(timestamp) {
            if (!timestamp) return null;
            // 이미 문자열이면 그대로 반환
            if (typeof timestamp === 'string') {
                return timestamp.substring(0, 19).replace('T', ' ');
            }
            return timestamp;
        }

        // 통계 로드
        async function loadStats() {
            try {
                // 새 SimulatorController stats API 사용
                const response = await fetch(`/api/simulator/stats?table=${currentTable}`);
                const data = await response.json();

                if (data.success && data.stats) {
                    // ASIS와 TOBE 통계 합산
                    let total = 0, success = 0, failed = 0, blocked = 0;

                    const processStats = (stats) => {
                        if (!stats) return;
                        stats.forEach(s => {
                            const cnt = parseInt(s.CNT) || 0;
                            total += cnt;
                            if (s.STATUS === 'SUCCESS') success += cnt;
                            else if (s.STATUS === 'FAILED') failed += cnt;
                            else if (s.STATUS === 'BLOCKED') blocked += cnt;
                        });
                    };

                    processStats(data.stats.asis);
                    processStats(data.stats.tobe);

                    document.getElementById('statTotal').textContent = total;
                    document.getElementById('statSuccess').textContent = success;
                    document.getElementById('statFailed').textContent = failed;
                    document.getElementById('statBlocked').textContent = blocked;
                }
            } catch (error) {
                console.error('통계 로딩 실패:', error);
            }
        }

        // 초기 로드
        document.addEventListener('DOMContentLoaded', function() {
            loadTableData('asis');
            loadTableData('tobe');
        });
    </script>
</body>
</html>
